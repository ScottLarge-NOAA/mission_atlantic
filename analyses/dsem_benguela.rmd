---
title: "Causal model of S. Benguela"
author: "Scott Large"
output: 
  html_document:
    code_folding: hide
date: "2024-06-19"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=12)
```


```{r load_dat, message = FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(lubridate)

# install.packages("dsem")
library(dsem) ## 1.2.1
library(phylopath)

all_dat <- readRDS(here::here("data/all_dat.rds"))
benguela_nino <- readRDS(here::here("data/bni.rds"))

upwelling <- readRDS(here::here("data/upwelling_index.rds")) %>% 
  filter(area == "total")

catches <- readRDS(here::here("data/pelagic_catch.rds"))

catches_m <- readRDS(here::here("data/pelagic_catch_monthly.rds"))

recruitment <- readRDS(here::here("data/pelagic_recruitment.rds")) %>% 
  filter(unit == "n")

biomass <- readRDS(here::here("data/pelagic_biomass.rds")) %>% 
  filter(indicator == "biomass") %>% 
  mutate(value = case_when(indicator == "biomass" ~ value/1000000,
                           indicator != "biomass" ~ value,
                           TRUE ~ NA_integer_))

cal_tab <- readRDS(here::here("data/calendar_table.rds"))

```

# Introduction ---

* IEA as tool for confronting trade-offs between multiple EBFM objectives 
* Causal models help to identify the magnitude and direction of direct and indirect effects
* Southern Benguela is an important and dynamic system, which has proven challenging to understand
    + Environmental drivers: 
        + Upwelling
        + BNI
            * Benguela Niños are thought to be associated with large-scale changes in wind patterns resulting in the poleward movement of warm tropical waters and may contribute to poor sardine recruitment (Boyer et al 2001)
            * Boyd et al. (1985) reported an order of magnitude reduction in sardine egg production, but good survival of larvae, following the 1984 Benguela Niño.
            * (Rouault and Tomety, 2022) SST seasonal predictability in the Benguela upwelling due to the leading lag correlation between ENSO and the Benguela upwelling SST
            * (Florenchie et al., 2003) Benguela Niños are generated by specific wind stress events in the west-central equatorial Atlantic, and progress from there as subsurface temperature anomalies that eventually outcropped only at the south-west African coast. These results suggest that it now may be possible to predict the occurrence of these disruptive events with a lead-time of 2 months.
            * (Imbol Koungue et al., 2019) Systematic study of Benguela Niño and Benguela Niña events during 1958 to 2015 including those that developed before the satellite era (1982) is carried out using an ocean general circulation model in combination with a linear equatorial model.)
    + Ecosystem processes
        + Phytoplankton
            * wind-driven upwelling at discrete upwelling centres in the southern Benguela is strongly pulsed and shows greater seasonal differences, with a narrow band of high plankton productivity in the southern part, restricted to the narrow coastal zone by warm Agulhas water offshore forming a front.
            * Close relationship is to be expected between primary production and upwelling of nutrient-rich water over short time scales, it is generally assumed that long-term shifts in upwelling-favourable winds will lead to changes in upwelling and, consequently, to changes in phytoplankton production and biomass on similar scales (Hampton, 2012). However, patterns observed from in situ and satellite data provide no clear indications to suggest that such a straight-forward link between primary production and upwelling variability occurs in the Benguela, but there is evidence of substantial interannual and decade-scale changes in both phytoplankton production and upwelling at a number of times and locations in both the northern and southern Benguela sub-systems.
(Verheye et al 2016) 
        + Zooplankton
        + Small Pelagic dynamics
    + Fishing
        + Small pelagic directed and bycatch
* Here, based on conceptual models developed through the ODEMM/IEA process, we develop a novel causal model to explore how fishing and the environment influence ecosystem indicators

# Methods ---

## Model area
* *TODO* Create map with the relevant spots identified

## Data ---

* *TODO* Decide if we want to include SST. If so, figure out the SST boxes for Southern and Western coastal areas (Maybe in one of Lamant's papers)?

* Benguela Niño index
    + Benguela Niños are characterized by persistent warmer-than-normal SST in Angola and northern Namibia and vice versa for Benguela Niñas. Monthly mean SSTs are from the upgraded version of Optimum Interpolation SSTs with improved bias corrections (OIv2.1; Huang et al., 2021). OIv2.1 data are available from September 1981 onward and on a 1° by 1° resolution. Benguela Niño index are defined as the averaged SST anomalies (SSTAs) in (10°–20°S, 7°–11°E).
```{r bni_data}
bni_summer <- benguela_nino %>% 
  mutate(year = lubridate::year(date),
         year = lead(year, n = 1),
         month = lubridate::month(date)) %>% 
  filter(year > 1982) %>% 
  group_by(year) %>% 
  summarize(bni = mean(bni, na.rm = TRUE),
            col = factor(ifelse(bni > 0, 2, 1)))

bni_s <- ggplot(bni_summer, aes(x = year, y = bni)) +
  geom_bar(aes(fill = col), stat = "identity", show.legend = FALSE) +
  geom_line(color = "black", linewidth = .5) +
  scale_fill_manual(values = c("blue", "red")) +
  labs(title = "Summer Benguela Niño Index (sBNI)",
       subtitle = "average December-March BNI",
       x = "",
       y = "") +
    theme_minimal() +
  NULL

bni_m <- ggplot(benguela_nino) +
  geom_bar(aes(x = date, y = bni, fill = col), stat = "identity", show.legend = FALSE)+
  geom_hline(yintercept = 0, linewidth = .75) +
  geom_line(aes(x = date, y = bni_curve), linewidth = .5) +
  theme_minimal() +
  scale_fill_manual(values = c("blue", "red")) +
  labs(title = "Benguela Niño Index (BNI)",
       subtitle = "monthly anomaly",
       x = "",
       y = "") +
  NULL


```

* Upwelling 
    + From Lamont et al 2018. Cumulative coastal upwelling from December to March
```{r, upwelling_dat}

upwelling_month <- upwelling %>% 
  mutate(upwelling_date = lag(year, n = 6), ##  years run from July (previous year) to June (current year). eg: 1979 = 1 July 1979 to 30 June 1980
         upwelling_year = lubridate::year(upwelling_date),
         months = lubridate::month(year)) %>% 
  filter(!is.na(upwelling_date)) 

upwelling_dat <- upwelling_month %>% ## cumulative coastal upwelling from December to March
  group_by(upwelling_year) %>%
  summarize(value = sum(value, na.rm = TRUE))

upwelling_summer_dat <- upwelling_month %>% 
  filter(!is.na(upwelling_date), 
         months %in% c(12, 1, 2, 3)) %>% ## cumulative coastal upwelling from December to March
  group_by(upwelling_year) %>%
  summarize(value = sum(value, na.rm = TRUE))


up_summer <- ggplot(upwelling_summer_dat, aes(x = upwelling_year, y = value/1000)) +
  geom_path() +
  scale_x_continuous(limits = c(1979, 2020), breaks = seq(1965, 2020, 5)) +
  labs(x = "", y = "", 
       title = "Upwelling index",
       subtitle = bquote("December-March cumulative upwelling"~(m^3~s^-1~100~m^-1)~x~1000)) +
  theme_minimal() +
  NULL

```
* Primary Production
    + *TODO* Check with Lynne on the source for these data. EwE data for the whole Southern Benguela
```{r pp_dat}

ind_list <- c("Phytoplankon 1", "Phytoplakton 2")
# , "Mesozooplankton", "Anchovy recruits", "Juvenile Hmack",
#               "Snoek", "Yellowtail", "Sardine", "Redeye", "Sciaenids", "Large M. paradoxus", "PF Chondrichthyans",
#               "BF Chondrichthyans", "Marine Mammals (seals&cetaceans)", "African Penguin", "Cape Gannet", "WC rock lobster")


pp_dat <- all_dat %>% 
  filter(name %in% ind_list) %>% 
  mutate(name = case_when(name == "Phytoplankon 1" ~ "Phytoplankton 1 (small)",
                          name == "Phytoplakton 2" ~ "Phytoplankton 2 (large)",
                          TRUE ~ name)) %>% 
  select(name, year, value)

pp_plot <- ggplot(pp_dat, aes(x = year, y = value, color = name)) +
  geom_path() +
    scale_x_continuous(limits = c(1978, 2020), breaks = seq(1965, 2020, 5)) +
  labs(x = "", y = "", 
       title = "modeled phytoplankton biomass",
       subtitle = "from Shannon et al ??? Ecopath with Ecosim model") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL


```
* Zooplankton
    + *TODO* Check with Lynne on the source for these data. EwE data for the whole Southern Benguela
```{r zoop_data}
zoop_dat <- all_dat %>% 
  filter(name %in% c("Macrozooplankton", "Mesozooplankton", "Microzooplankton")) %>% 
  select(year, name, value)


zoop_plot <- ggplot(zoop_dat, aes(x = year, y = value, color = name)) +
  geom_path() +
    scale_x_continuous(limits = c(1978, 2020), breaks = seq(1965, 2020, 5)) +
  labs(x = "", y = "", 
       title = "modeled zooplankton biomass",
       subtitle = "from Shannon et al ??? Ecopath with Ecosim model") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL
```
* Small pelagic population dynamics
    + Recruitment
    + Biomass
```{r recruits, warning=FALSE, message=FALSE}

rec1 <- ggplot(recruitment, aes(x = year, y = value, group = species, color = species)) +
  geom_path() +
  scale_x_continuous(limits = c(1979, 2021), breaks = seq(1965, 2020, 5)) +
    scale_color_brewer(palette = "Set2") +
  labs(x = "",
       y = "",
       title = "small pelagic recruitment",
       subtitle = "autumn/winter (May/June) acoustic survey (billions)") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL

```
```{r biomass, warning=FALSE, message=FALSE}

bio1 <- ggplot(biomass, aes(x = year, y = value, group = species, color = species)) +
  facet_wrap(~ factor(area, levels = c("east", "west", "total")), ncol = 1) +
  geom_path() +
  scale_color_brewer(palette = "Set2") +
  scale_x_continuous(limits = c(1979, 2020), breaks = seq(1965, 2020, 5)) +
  labs(x = "",
       y = "",
       title = "small pelagic spawner biomass",
       subtitle = "spring/summer (October/November) acoustic survey (million tonnes)") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL

```
* Fishing
    + Small pelagic catches
```{r pel_catch, warning=FALSE, message=FALSE}

sp_plot <- ggplot(catches, aes(x = year, y = value/1000, group = species, fill = species, color = species)) +
  geom_path() +
  # geom_bar(stat = "identity") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = "", y = "",
       title = "small pelagic catches",
       subtitle = "tonnes (thousands)") +
  NULL

```


```{r sardine_month, fig.width=12}

sardine_d <- catches_m %>% 
  filter(species == "sardine") %>% 
  select(-species) %>% 
  pivot_longer(Jan:Dec, names_to = "month", values_to = "value") %>% 
  mutate(month = factor(month.name[match(.$month, month.abb)], levels = month.name[c(6:12, 1:5)]),
         year = factor(year),
         table = case_when(table == "1a" ~ "directed fishery west of Cape Agulhas",
                           table == "1b" ~ "directed fishery east of Cape Agulhas",
                           table == "1c" ~ "bycatch with anchovy fishery",
                           TRUE ~ NA_character_)) 


sard1 <- ggplot(sardine_d, aes(x = month, y = year, height = value, group = year, fill = table)) +
  ggridges::geom_density_ridges(stat = "identity", scale = 3, alpha = 0.4, show.legend = FALSE) +
  facet_wrap(~table, ncol = 3) +
  labs(x = "", y = "",
       title = "distribution of monthly sardine commercial catches") +
  coord_cartesian(clip = "off") +
  theme_minimal() +
  theme(axis.text.y = element_text(vjust = 0),
        axis.text.x = element_text(angle = 45, vjust = .5)) +
  NULL
```
```{r anchovy_month}

anchovy_d <- catches_m %>% 
  filter(species == "anchovy") %>% 
  select(-species, -table) %>% 
  pivot_longer(Jan:Dec, names_to = "month", values_to = "value") %>% 
  mutate(month = factor(month.name[match(.$month, month.abb)], levels = month.name[c(6:12, 1:5)]),
         year = factor(year)) 


anch1 <- ggplot(anchovy_d, aes(x = month, y = year, height = value, group = year)) +
  ggridges::geom_density_ridges(stat = "identity", scale = 3, fill = "purple", alpha = 0.4, show.legend = FALSE) +
  # facet_wrap(~table, ncol = 3) +
  labs(x = "", y = "",
       title = "distribution of monthly anchovy commercial catches") +
  coord_cartesian(clip = "off") +
  theme_minimal() +
  theme(axis.text.y = element_text(vjust = 0),
        axis.text.x = element_text(angle = 45, vjust = .5)) +
  NULL

```
* These data are aggregated according to their temporal occurrence
```{r calendar_table}

month_ord <- month.name[c(7:12, 1:6)]
process_ord <- c("upwelling", "summer Benguela Niño Index", "primary production (offshore)", "primary production (inshore)",
                 "zooplankton", "Sardine recruitment survey", "Anchovy recruitment survey", "Sardine biomass survey",
                 "Anchovy biomass survey", "Sardine bycatch", "Anchovy catch", "Sardine catch")
                 
seasons <- data.frame(xstart = seq(0.5, 9.5, 3), xend = seq(3.5, 12.5, 3), 
                      season = factor(c("winter", "spring", "summer", "autumn"),
                                   levels = c("winter", "spring", "summer", "autumn")))

all_cal <- cal_tab %>% 
  mutate(year = ifelse(month_start > month_end, 2019, 2020),
         month_end = as.Date(sprintf("2020-%s-01", month_end)),
         month_start = as.Date(sprintf("%s-%s-01", year, month_start)),
         process = factor(process, levels = process_ord)) %>% 
  group_by(process) %>% 
  tidyr::complete(month_start = seq(month_start, month_end, by = "month")) %>% 
  tidyr::fill(lag, .direction = "down") %>% 
  select(process, month = month_start, lag) %>% 
  mutate(month = factor(lubridate::month(month, label = TRUE, abbr = FALSE),
                        levels = month_ord))

timeline_plot <- ggplot() +
  geom_rect(data = seasons, aes(xmin = xstart, xmax = xend, 
                                ymin = -Inf, ymax = Inf, fill = season), alpha = 0.4) +
  geom_point(data = all_cal, aes(x = month, y = process, color = as.factor(lag)), size = 5) +
  scale_color_manual(values = c("black", "red", "blue")) +
  theme_minimal() +
  labs(x = "", y = "", 
       color = "lag",
       title = "Timeline for important Southern Benguela processes",
       subtitle = "Lags indicate events in the current year (T = 0) that are affected in year T+lag)") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, vjust = .5))

```

```{r dsem_data, warning=FALSE, message=FALSE}

sem_dat_long <- data.frame(year = 1977:2023) %>% 
  left_join(upwelling_summer_dat %>% 
  rename(year = upwelling_year,
         upwelling = value)) %>% 
  left_join(bni_summer %>% 
              select(-col) %>% 
              rename(sbni = bni)) %>% 
  left_join(pp_dat %>% 
              pivot_wider(names_from = name, values_from = value) %>% 
              rename(pp_large = "Phytoplankton 2 (large)",
                     pp_small = "Phytoplankton 1 (small)")) %>% 
  left_join(zoop_dat %>% 
              pivot_wider(names_from = name, values_from = value) %>% 
              rename_with(tolower)) %>% 
  left_join(recruitment %>% 
              select(year, species, value) %>%
              pivot_wider(names_from = species, names_glue = "{tolower(gsub(' ', '_', species))}_recruits", values_from = value)) %>% 
  left_join(biomass %>% 
              select(year, species, area, value) %>%
              pivot_wider(names_from = c(species, area), names_glue = "{tolower(gsub(' ', '_', species))}_biomass_{area}", values_from = value)) %>% 
  left_join(catches %>% 
              select(year, species, value) %>% 
              pivot_wider(names_from = species, names_glue = "{tolower(gsub(' ', '_', species))}_catches", values_from = value)) %>% 
  pivot_longer(-year, names_to = "var", values_to = "val") %>% 
  group_by(var) %>% 
## Remove roundeye for now
  mutate(val = scale(val, scale = TRUE, center = TRUE)[,1]) %>% 
  filter(!stringr::str_detect(var, "roundeye")) 

sem_dat <- sem_dat_long %>% 
  pivot_wider(names_from = var, values_from = val) 

zplot <- ggplot(sem_dat_long, aes(x = year, y = val, group = var, color = var)) +
  geom_path(show.legend = FALSE) +
  gghighlight::gghighlight(unhighlighted_params = list(alpha = 0.4)) +
  facet_wrap(~var, ncol = 3) +
  labs(x = "", y = "z-score", color = "",
       title = "Indicators used in dsem analysis") +
  theme_minimal() +
  theme(legend.position = "bottom")

zplot

timeline_plot
```

## Causal modeling ---
* Initial conceptual model is taken from ODEMM/IEA process (Skein et al 2022 and Bornman et al 2024)
* Dynamic Structural Equation Model (Thorson et al 2024)


# Results ---

## Anchovy model ---
```{r sem_anchovy}
sem_dat_anch <- sem_dat %>% 
  select(year, upwelling, pp_large, pp_small, macrozooplankton,
         mesozooplankton, microzooplankton, 
         anchovy_recruits, anchovy_biomass_total, anchovy_catches) %>% 
  as.data.frame()

rownames(sem_dat_anch) <- sem_dat_anch$year
sem_dat_anch <- sem_dat_anch[,-1]
# Z = ts(sem_dat_anch)

# family = rep('fixed', ncol(sem_dat_anch))

## guidance from ??make_dsem_ram()
### X -> Y, 1, XtoY indicates that X in time T affects Y in time T+1)
### X -> Y, 0, XtoY indicates X affects Y simultaneously (lag=0) 
# Specify model
sem_anch <- "
  # Link, lag, param_name (NA = off), fixed value (optional, 1 if param is off)
  
  upwelling -> pp_large, 0, upwelling_to_ppL
  upwelling -> pp_small, 0, upwelling_to_ppS
  pp_large -> macrozooplankton, 0, ppL_to_zoopMacro
  pp_small -> macrozooplankton, 0, ppS_to_zoopMacro
  pp_large -> mesozooplankton, 0, ppL_to_zoopMeso
  pp_small -> mesozooplankton, 0, ppS_to_zoopMeso
  pp_large -> microzooplankton, 0, ppL_to_zoopMicro
  pp_small -> microzooplankton, 0, ppS_to_zoopMicro
  macrozooplankton -> anchovy_recruits, 1, zoopMacro_to_recruitsA
  mesozooplankton -> anchovy_recruits, 1, zoopMeso_to_recruitsA
  microzooplankton -> anchovy_recruits, 1, zoopMicro_to_recruitsA
  anchovy_recruits -> anchovy_biomass_total, 1, recruitsA_to_biomssA
  anchovy_biomass_total -> anchovy_catches, 1, biomassA_to_catches
  
  upwelling -> upwelling, 1, AR1, 0.001
  pp_large -> pp_large, 1,  AR2, 0.001
  pp_small -> pp_small, 1, AR3, 0.001
  macrozooplankton -> macrozooplankton, 1, AR4, 0.001
  mesozooplankton -> mesozooplankton, 1, AR5, 0.001
  microzooplankton -> microzooplankton, 1, AR6, 0.001
  anchovy_recruits ->  anchovy_recruits, 1, AR7, 0.001
  anchovy_biomass_total -> anchovy_biomass_total, 1, AR8, 0.001
  anchovy_catches -> anchovy_catches, 1, AR9, 0.001
"

# Fit dsem
fit_anch = dsem(sem = sem_anch,
            tsdata = ts(sem_dat_anch),
            family = rep('fixed', ncol(sem_dat_anch)),
            control = dsem_control(use_REML = TRUE, quiet=TRUE))

ParHat_anch = fit_anch$obj$env$parList()

dag_anchovy <- phylopath::DAG(pp_large~upwelling,
                    pp_small~upwelling,
                    macrozooplankton~pp_large,
                    mesozooplankton~pp_large,
                    microzooplankton~pp_large,
                    macrozooplankton~pp_small,
                    mesozooplankton~pp_small,
                    microzooplankton~pp_small,
                    anchovy_recruits~macrozooplankton,
                    anchovy_recruits~mesozooplankton,
                    anchovy_recruits~microzooplankton,
                    anchovy_biomass~anchovy_recruits,
                    # anchovy_biomass~upwelling,
                    anchovy_catch~anchovy_biomass)
  
da_plot <- plot(dag_anchovy, edge.width = 1, type="width",
           text_size = 5, show.legend = FALSE, box_x = 30) +
     scale_x_continuous(expand = c(0.4, 0.1))+
  labs(title = "directed acyclic graph - anchovy") +
  NULL
da_plot$layers[[1]]$mapping$edge_width = 1
da_plot

```

```{r dsem_anch_ts, warning=FALSE, message=FALSE}

# Timeseries plot
raw_dat <- data.frame(year = rownames(sem_dat_anch), 
                         sem_dat_anch) %>% 
  pivot_longer(!year, names_to = "var", values_to = "value")

pred_model <- data.frame(year = rownames(sem_dat_anch), 
                         ParHat_anch$x_tj) %>% 
  pivot_longer(!year, names_to = "var", values_to = "predicted")

pred_sd <- data.frame(year = rownames(sem_dat_anch),
                      as.list(fit_anch$sdrep,what="Std.")$x_tj) %>% 
  pivot_longer(!year, names_to = "var", values_to = "SD")

pred_all <- raw_dat %>% 
  left_join(pred_model, by = join_by(year, var)) %>% 
  left_join(pred_sd, by = join_by(year, var)) %>% 
  mutate(lower = predicted - ifelse(is.na(SD), 0, SD),
         upper = predicted + ifelse(is.na(SD), 0, SD),
         year = as.numeric(year)) 

ts_plot_anch <- ggplot(pred_all, aes(x = year, y = predicted, ymin = lower, ymax = upper, group = var)) +
  geom_path() +
  geom_ribbon(alpha = 0.2, color = "blue", fill = "blue") +
  geom_point(aes(x = year, y = value)) +
  facet_wrap(~var) +
  scale_x_continuous(limits = c(1979, 2020), breaks = seq(1965, 2020, 5)) +
  theme_minimal() +
  labs(x = "", y = "",
       title = "Estimated values",
       subtitle = "measurements (black dots), predicted values (blue lines), and 95% predictive intervals (\u00B11.96 SE)") +
  NULL
ts_plot_anch
```



```{r dsem_anch_dag}

# dag_plot0 <- plot( (as_fitted_DAG(fit, lag = 0)), type = "width", curvature = 0.01)

p1_anch <- plot( (as_fitted_DAG(fit_anch)), edge.width = 1, type="width",
           text_size = 5, show.legend = FALSE, box_x = 30) +
     scale_x_continuous(expand = c(0.4, 0.1))+
  labs(title = "simultaneous effects")
p1_anch$layers[[1]]$mapping$edge_width = 1
p2_anch <- plot( (as_fitted_DAG(fit_anch, what="p_value")), edge.width = .5, type = "width",
           text_size = 5, show.legend=FALSE, colors=c('black', 'black'), box_x = 30) +
     scale_x_continuous(expand = c(0.4, 0.1)) +
  labs(title = "Two-sided p-value")
p2_anch$layers[[1]]$mapping$edge_width = 0.5


coef_dat_anch <- data.frame(name = colnames(sem_dat_anch), summary(fit_anch$sdrep)[1:9,]) %>% 
  rename(coef = 2, "std_error" = 3) %>% 
  mutate(upper = coef + std_error,
         lower = coef - std_error)

coef_plot_anch <- ggplot(coef_dat_anch, aes(x = name, y = coef, ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0) +
  geom_linerange() +
  geom_point() + 
  coord_flip() +
  labs(x = "", y = "standardized regression coefficient") +
  theme_bw()

p1_anch
p2_anch
coef_plot_anch
```

## Sardine model--- 

```{r sem_sardine}
sem_dat_sardine <- sem_dat %>% 
  select(year, 
         upwelling, sbni, ## environmental drivers
         pp_large, pp_small, ## primary producers
         macrozooplankton, mesozooplankton, microzooplankton, ## zooplankton
         sardine_recruits, sardine_biomass_total, ## fish
         anchovy_catches, sardine_catches) %>% ## removals
  as.data.frame()

rownames(sem_dat_sardine) <- sem_dat_sardine$year
sem_dat_sardine <- sem_dat_sardine[,-1]
# z_sard = ts(sem_dat_sardine)

# family = rep('fixed', ncol(sem_dat_sardine))

## guidance from ??make_dsem_ram()
### X -> Y, 1, XtoY indicates that X in time T affects Y in time T+1)
### X -> Y, 0, XtoY indicates X affects Y simultaneously (lag=0) 

# Specify model
sem_sard <- "
  # Link, lag, param_name (NA = off), fixed value (optional, 1 if param is off)
  
  upwelling -> pp_large, 0, upwelling_to_ppL
  upwelling -> pp_small, 0, upwelling_to_ppS
  pp_large -> macrozooplankton, 0, ppL_to_zoopMacro
  pp_small -> macrozooplankton, 0, ppS_to_zoopMacro
  pp_large -> mesozooplankton, 0, ppL_to_zoopMeso
  pp_small -> mesozooplankton, 0, ppS_to_zoopMeso
  pp_large -> microzooplankton, 0, ppL_to_zoopMicro
  pp_small -> microzooplankton, 0, ppS_to_zoopMicro
  sbni -> sardine_recruits, 0, sbni_to_recruitsS
  macrozooplankton -> sardine_recruits, 1, zoopMacro_to_recruitsS
  mesozooplankton -> sardine_recruits, 1, zoopMeso_to_recruitsS
  microzooplankton -> sardine_recruits, 1, zoopMicro_to_recruitsS
  sardine_recruits -> sardine_biomass_total, 1, recruitsA_to_biomssS
  anchovy_catches -> sardine_biomass_total, 0, catchesA_to_biomassS
  sardine_biomass_total -> sardine_catches, 2, biomassA_to_catchesS
  
  upwelling -> upwelling, 1, AR1, 0.001
  pp_large -> pp_large, 1,  AR2, 0.001
  pp_small -> pp_small, 1, AR3, 0.001
  macrozooplankton -> macrozooplankton, 1, AR4, 0.001
  mesozooplankton -> mesozooplankton, 1, AR5, 0.001
  microzooplankton -> microzooplankton, 1, AR6, 0.001
  sardine_recruits ->  sardine_recruits, 1, AR7, 0.001
  sardine_biomass_total -> sardine_biomass_total, 1, AR8, 0.001
  anchovy_catches -> anchovy_catches, 1, AR9, 0.001
  sbni -> sbni, 1, AR10, 0.001
  sardine_catches -> sardine_catches, 1, AR11, 0.001
"

# Fit dsem
fit_sardine = dsem( sem = sem_sard,
            tsdata = ts(sem_dat_sardine),
            family =  rep('fixed', ncol(sem_dat_sardine)),
            control = dsem_control(use_REML = TRUE, quiet=TRUE))

ParHat_sardine = fit_sardine$obj$env$parList()
```

```{r dsem_sardine_ts, warning=FALSE, message=FALSE}

# Timeseries plot
raw_dat_sardine <- data.frame(year = rownames(sem_dat_sardine), 
                         sem_dat_sardine) %>% 
  pivot_longer(!year, names_to = "var", values_to = "value")

pred_model_sardine <- data.frame(year = rownames(sem_dat_sardine), 
                         ParHat_sardine$x_tj) %>% 
  pivot_longer(!year, names_to = "var", values_to = "predicted")

pred_sd_sardine <- data.frame(year = rownames(sem_dat_sardine),
                      as.list(fit_sardine$sdrep,what="Std.")$x_tj) %>% 
  pivot_longer(!year, names_to = "var", values_to = "SD")

pred_all_sardine <- raw_dat_sardine %>% 
  left_join(pred_model_sardine, by = join_by(year, var)) %>% 
  left_join(pred_sd_sardine, by = join_by(year, var)) %>% 
  mutate(lower = predicted - ifelse(is.na(SD), 0, SD),
         upper = predicted + ifelse(is.na(SD), 0, SD),
         year = as.numeric(year)) 

ts_plot_sardine <- ggplot(pred_all_sardine, aes(x = year, y = predicted, ymin = lower, ymax = upper, group = var)) +
  geom_path() +
  geom_ribbon(alpha = 0.2, color = "blue", fill = "blue") +
  geom_point(aes(x = year, y = value)) +
  facet_wrap(~var) +
  scale_x_continuous(limits = c(1979, 2020), breaks = seq(1965, 2020, 5)) +
  theme_minimal() +
  labs(x = "", y = "",
       title = "Estimated values",
       subtitle = "measurements (black dots), predicted values (blue lines), and 95% predictive intervals (\u00B11.96 SE)") +
  NULL
ts_plot_sardine
```

```{r dsem_sardine_dag, fig.height = 12, fig.width = 15}

# dag_plot0 <- plot( (as_fitted_DAG(fit, lag = 0)), type = "width", curvature = 0.01)
sard_lags <- max(as.numeric(summary(fit_sardine)$lag))
for(i in 0:sard_lags){
  
  p1_sardine <- NULL
  p2_sardine <- NULL

  p1_sardine <- plot( (as_fitted_DAG(fit_sardine, lag = i)), edge_width = 1, type="width",
                      text_size = 4, show.legend = FALSE, box_x = 12) +
    scale_x_continuous(expand = c(0.05, 0.05)) +
        # scale_x_continuous(expand = expansion()) +
    labs(title = sprintf("lag %s effects", i)) +
    NULL

   p1_sardine <- ggplot_build(p1_sardine)
 p1_sardine$data[[1]]$edge_width <- 1
 
    # p1_sardine$layers[[1]]$mapping$edge_width = 0.5
# p1_sardine$layers[[1]]$mapping$edge_width 

  p2_sardine <- plot( (as_fitted_DAG(fit_sardine, what="p_value", lag = i)), #edge_width = 2, 
                      type = "width",
                      text_size = 4, show.legend = FALSE, colors=c('black', 'black'), 
                      box_x = 12) +
    scale_x_continuous(expand = c(0.05, 0.05)) +
    # scale_x_continuous(expand = expansion())+
    labs(title = "Two-sided p-value")
    # p2_sardine$layers[[1]]$mapping$edge_width = 0.5
  # p2_sardine$layers[[1]]$mapping$edge_width = as.symbol("1- abs(weight)")
 
 p2_sardine <- ggplot_build(p2_sardine)
 p2_sardine$data[[1]]$edge_width <- 1
 
 print(wrap_ggplot_grob(ggplot_gtable(p1_sardine))/wrap_ggplot_grob(ggplot_gtable(p2_sardine)))

 # print(p1_sardine/plot(tt))
  # print(p2_sardine)

}
tt <- p2_sardine$data[[1]]
p2_sardine$plot
coef_dat_sardine <- data.frame(name = colnames(sem_dat_sardine), summary(fit_sardine$sdrep)[1:11,]) %>% 
  rename(coef = 2, "std_error" = 3) %>% 
  mutate(upper = coef + std_error,
         lower = coef - std_error)

coef_plot_sardine <- ggplot(coef_dat_sardine, aes(x = name, y = coef, ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0) +
  geom_linerange() +
  geom_point() + 
  coord_flip() +
  labs(x = "", y = "standardized regression coefficient") +
  theme_bw()

# p1_sardine
# p2_sardine
coef_plot_sardine
```


# Discussion ---




## Supplemental plots
```{r supplement_plots, include=FALSE, echo = FALSE}

bni_m / bni_s
up_summer
pp_plot
zoop_plot
rec1
bio1
sp_plot
sard1
anch1

```