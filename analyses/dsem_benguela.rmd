---
title: "Causal model of S. Benguela"
author: "Scott Large"
output: 
  html_document:
    code_folding: hide
date: "2024-06-19"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load_dat, message = FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(lubridate)

# install.packages("dsem")
library(dsem) ## 1.2.1
library(phylopath)

# library(dynlm)
# library(ggplot2)
# library(reshape)
# library(gridExtra)
# library(phylopath)


all_dat <- readRDS(here::here("data/all_dat.rds"))
benguela_nino <- readRDS(here::here("data/bni.rds"))

upwelling <- readRDS(here::here("data/upwelling_index.rds")) %>% 
  filter(area == "total")

catches <- readRDS(here::here("data/pelagic_catch.rds"))

catches_m <- readRDS(here::here("data/pelagic_catch_monthly.rds"))

recruitment <- readRDS(here::here("data/pelagic_recruitment.rds")) %>% 
  filter(#species == "Anchovy",
         unit == "n")#,
         #year <= 2020)

biomass <- readRDS(here::here("data/pelagic_biomass.rds")) %>% 
  filter(#species == "Anchovy",
         #year <= 2020,
         indicator == "biomass") %>% 
  mutate(value = case_when(indicator == "biomass" ~ value/1000000,
                           indicator != "biomass" ~ value,
                           TRUE ~ NA_integer_))

```

# Methods ---
## Environment ---

### SST

*TODO* Figure out the SST boxes for Southern and Western coastal areas (Maybe in one of Lamant's papers)

### Benguela Niño index

Benguela Niños are characterized by persistent warmer-than-normal SST in Angola and northern Namibia and vice versa for Benguela Niñas. They are generally caused by changes in the winds along the western equatorial Atlantic,

Benguela Niños are thought to be associated with large-scale changes in wind patterns resulting in the poleward movement of warm tropical waters and may contribute to poor sardine recruitment (Boyer et al 2001)

Boyd et al. (1985) reported an order of magnitude reduction in sardine egg production, but good survival of larvae, following the 1984 Benguela Niño.

* (Rouault and Tomety, 2022) SST seasonal predictability in the Benguela upwelling due to the leading lag correlation between ENSO and the Benguela upwelling SST
* (Florenchie et al., 2003) Benguela Niños are generated by specific wind stress events in the west-central equatorial Atlantic, and progress from there as subsurface temperature anomalies that eventually outcropped only at the south-west African coast. These results suggest that it now may be possible to predict the occurrence of these disruptive events with a lead-time of 2 months.
* (Imbol Koungue et al., 2019) Systematic study of Benguela Niño and Benguela Niña events during 1958 to 2015 including those that developed before the satellite era (1982) is carried out using an ocean general circulation model in combination with a linear equatorial model.

```{r bni_data}
bni_summer <- benguela_nino %>% 
  mutate(year = lubridate::year(date),
         year = lead(year, n = 1),
         month = lubridate::month(date)) %>% 
  filter(year > 1982) %>% 
  group_by(year) %>% 
  summarize(bni = mean(bni, na.rm = TRUE),
            col = factor(ifelse(bni > 0, 2, 1)))

bni_s <- ggplot(bni_summer, aes(x = year, y = bni)) +
  geom_bar(aes(fill = col), stat = "identity", show.legend = FALSE) +
  geom_line(color = "black", linewidth = .5) +
  scale_fill_manual(values = c("blue", "red")) +
  labs(title = "Summer Benguela Niño Index (sBNI)",
       subtitle = "average December-March BNI",
       x = "",
       y = "") +
    theme_minimal() +
  NULL

bni_m <- ggplot(benguela_nino) +
  geom_bar(aes(x = date, y = bni, fill = col), stat = "identity", show.legend = FALSE)+
  geom_hline(yintercept = 0, linewidth = .75) +
  geom_line(aes(x = date, y = bni_curve), linewidth = .5) +
  theme_minimal() +
  scale_fill_manual(values = c("blue", "red")) +
  labs(title = "Benguela Niño Index (BNI)",
       subtitle = "monthly anomaly",
       x = "",
       y = "") +
  NULL

bni_m / bni_s
```

### Upwelling 

```{r, upwelling_dat}

upwelling_month <- upwelling %>% 
  mutate(upwelling_date = lag(year, n = 6), ##  years run from July (previous year) to June (current year). eg: 1979 = 1 July 1979 to 30 June 1980
         upwelling_year = lubridate::year(upwelling_date),
         months = lubridate::month(year)) %>% 
  filter(!is.na(upwelling_date)) 

upwelling_dat <- upwelling_month %>% ## cumulative coastal upwelling from December to March
  group_by(upwelling_year) %>%
  summarize(value = sum(value, na.rm = TRUE))

upwelling_summer_dat <- upwelling_month %>% 
  filter(!is.na(upwelling_date), 
         months %in% c(12, 1, 2, 3)) %>% ## cumulative coastal upwelling from December to March
  group_by(upwelling_year) %>%
  summarize(value = sum(value, na.rm = TRUE))


up_summer <- ggplot(upwelling_summer_dat, aes(x = upwelling_year, y = value/1000)) +
  geom_path() +
  scale_x_continuous(limits = c(1979, 2020), breaks = seq(1965, 2020, 5)) +
  labs(x = "", y = "", 
       title = "Upwelling index",
       subtitle = bquote("December-March cumulative upwelling"~(m^3~s^-1~100~m^-1)~x~1000)) +
  theme_minimal() +
  NULL

up_summer


```


## Ecosystem ---

### Primary Production

EwE data for the whole Southern Benguela

wind-driven upwelling at discrete upwelling centres in the southern Benguela is strongly pulsed and shows greater seasonal differences, with a narrow band of high plankton productivity in the southern part, restricted to the narrow coastal zone by warm Agulhas water offshore forming a front. 

Close relationship is to be expected between primary production and upwelling of nutrient-rich water over short time scales, it is generally assumed that long-term shifts in upwelling-favourable winds will lead to changes in upwelling and, consequently, to changes in phytoplankton production and biomass on similar scales (Hampton, 2012). However, patterns observed from in situ and satellite data provide no clear indications to suggest that such a straight-forward link between primary production and upwelling variability occurs in the Benguela, but there is evidence of substantial interannual and decade-scale changes in both phytoplankton production and upwelling at a number of times and locations in both the northern and southern Benguela sub-systems.
(Verheye et al 2016)

```{r pp_dat}

ind_list <- c("Phytoplankon 1", "Phytoplakton 2")
# , "Mesozooplankton", "Anchovy recruits", "Juvenile Hmack",
#               "Snoek", "Yellowtail", "Sardine", "Redeye", "Sciaenids", "Large M. paradoxus", "PF Chondrichthyans",
#               "BF Chondrichthyans", "Marine Mammals (seals&cetaceans)", "African Penguin", "Cape Gannet", "WC rock lobster")


pp_dat <- all_dat %>% 
  filter(name %in% ind_list) %>% 
  mutate(name = case_when(name == "Phytoplankon 1" ~ "Phytoplankton 1 (small)",
                          name == "Phytoplakton 2" ~ "Phytoplankton 2 (large)",
                          TRUE ~ name)) %>% 
  select(name, year, value)

ggplot(pp_dat, aes(x = year, y = value, color = name)) +
  geom_path() +
    scale_x_continuous(limits = c(1978, 2020), breaks = seq(1965, 2020, 5)) +
  labs(x = "", y = "", 
       title = "modeled phytoplankton biomass",
       subtitle = "from Shannon et al ??? Ecopath with Ecosim model") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL



```



### Zooplankton

EwE data for the whole Southern Benguela

```{r pp_data}
zoop_dat <- all_dat %>% 
  filter(name %in% c("Macrozooplankton", "Mesozooplankton", "Microzooplankton")) %>% 
  select(year, name, value)


ggplot(zoop_dat, aes(x = year, y = value, color = name)) +
  geom_path() +
    scale_x_continuous(limits = c(1978, 2020), breaks = seq(1965, 2020, 5)) +
  labs(x = "", y = "", 
       title = "modeled zooplankton biomass",
       subtitle = "from Shannon et al ??? Ecopath with Ecosim model") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL


```


### Recruitment

```{r recruits, warning=FALSE, message=FALSE}

rec1 <- ggplot(recruitment, aes(x = year, y = value, group = species, color = species)) +
  geom_path() +
  scale_x_continuous(limits = c(1979, 2021), breaks = seq(1965, 2020, 5)) +
    scale_color_brewer(palette = "Set2") +
  labs(x = "",
       y = "",
       title = "small pelagic recruitment",
       subtitle = "autumn/winter (May/June) acoustic survey (billions)") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL

rec1

```

### Biomass

```{r biomass, warning=FALSE, message=FALSE}

bio1 <- ggplot(biomass, aes(x = year, y = value, group = species, color = species)) +
  facet_wrap(~ factor(area, levels = c("east", "west", "total")), ncol = 1) +
  geom_path() +
  scale_color_brewer(palette = "Set2") +
  scale_x_continuous(limits = c(1979, 2020), breaks = seq(1965, 2020, 5)) +
  labs(x = "",
       y = "",
       title = "small pelagic spawner biomass",
       subtitle = "spring/summer (October/November) acoustic survey (million tonnes)") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL

bio1

```

## Fishing ---

### Pelagic catches

```{r pel_catch, warning=FALSE, message=FALSE}

ggplot(catches, aes(x = year, y = value/1000, group = species, fill = species, color = species)) +
  geom_path() +
  # geom_bar(stat = "identity") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = "", y = "",
       title = "small pelagic catches",
       subtitle = "tonnes (thousands)") +
  NULL

```

Monthly sardine:


```{r sardine_month, fig.width=12}
sardine_directed <- catches_m %>% 
  filter(species == "sardine",
         table == "1a",
         year > 1983) %>% 
  pivot_longer(Jan:Dec, names_to = "month", values_to = "value") %>% 
  mutate(month = factor(month.name[match(.$month, month.abb)], levels = month.name[c(6:12, 1:5)]),
         year = factor(year)) %>% 
  select(-table, -species)

sardine_d <- catches_m %>% 
  filter(species == "sardine",
         year > 1983) %>% 
  select(-species) %>% 
  pivot_longer(Jan:Dec, names_to = "month", values_to = "value") %>% 
  mutate(month = factor(month.name[match(.$month, month.abb)], levels = month.name[c(6:12, 1:5)]),
         year = factor(year),
         table = case_when(table == "1a" ~ "directed fishery west of Cape Agulhas",
                           table == "1b" ~ "directed fishery east of Cape Agulhas",
                           table == "1c" ~ "bycatch with anchovy fishery",
                           TRUE ~ NA_character_)) 


sard1 <- ggplot(sardine_d, aes(x = month, y = year, height = value, group = year, fill = table)) +
  ggridges::geom_density_ridges(stat = "identity", scale = 3, alpha = 0.4, , show.legend = FALSE) +
  facet_wrap(~table, ncol = 3) +
  labs(x = "", y = "",
       title = "distribution of monthly sardine commercial catches") +
  coord_cartesian(clip = "off") +
  theme_minimal() +
  theme(axis.text.y = element_text(vjust = 0),
        axis.text.x = element_text(angle = 45, vjust = .5)) +
  NULL

sard1
# 
# 
# sard1 <- ggplot(sardine_directed, aes(x = month, y = year, height = value, group = year)) +
#   ggridges::geom_density_ridges2(stat = "identity", scale = 3, fill = "red", alpha = 0.4) +
#   labs(x = "", y = "",
#        title = "distribution of monthly sardine commercial catches west of Cape Agulhas",
#        subtitle = "directed catch, bycatch with the round herring, and ‘large’ sardine bycatch") +
#   # coord_cartesian(clip = "off") + 
#   theme_minimal() +
#   theme(axis.text.y = element_text(vjust = 0),
#         axis.text.x = element_text(angle = 45, vjust = .5)) +
#   NULL


```


Table 1b: The monthly sardine commercial catch tonnage (in thousands of tons) landed as directed catch (1989‐2020) or bycatch with the round herring fishery (1989‐2010) or ‘large’ sardine bycatch (2011‐2020), east of Cape Agulhas. There was no catch east of Cape Agulhas prior to 1989.

Table 1c: The monthly sardine commercial catch tonnage (in thousands of tons) landed as bycatch with the anchovy fishery (1987‐2010) or ‘small’ sardine bycatch (2011‐2020), west of Cape Agulhas. These data include the small amount sof sardine landed east of Cape Agulhas.



## Causal model ---
```{r bs_dsem, eval=FALSE, include=FALSE}

data(bering_sea)
Z = ts( bering_sea )
family = rep('fixed', ncol(bering_sea))

# Specify model
sem = "
  # Link, lag, param_name
  log_seaice -> log_CP, 0, seaice_to_CP
  log_CP -> log_Cfall, 0, CP_to_Cfall
  log_CP -> log_Esummer, 0, CP_to_E
  log_PercentEuph -> log_RperS, 0, Seuph_to_RperS
  log_PercentCop -> log_RperS, 0, Scop_to_RperS
  log_Esummer -> log_PercentEuph, 0, Esummer_to_Suph
  log_Cfall -> log_PercentCop, 0, Cfall_to_Scop
  SSB -> log_RperS, 0, SSB_to_RperS

  log_seaice -> log_seaice, 1, AR1, 0.001
  log_CP -> log_CP, 1,  AR2, 0.001
  log_Cfall -> log_Cfall, 1, AR4, 0.001
  log_Esummer -> log_Esummer, 1, AR5, 0.001
  SSB -> SSB, 1, AR6, 0.001
  log_RperS ->  log_RperS, 1, AR7, 0.001
  log_PercentEuph -> log_PercentEuph, 1, AR8, 0.001
  log_PercentCop -> log_PercentCop, 1, AR9, 0.001
"

# Fit
fit = dsem( sem = sem,
            tsdata = Z,
            family = family,
            control = dsem_control(use_REML=FALSE, quiet=FALSE) )
ParHat = fit$obj$env$parList()

summary(fit)

```

```{r dsem_ts, eval=FALSE, include=FALSE}
# Timeseries plot
raw_dat <- data.frame(year = rownames(bering_sea), 
                         bering_sea) %>% 
  pivot_longer(!year, names_to = "var", values_to = "value")

pred_model <- data.frame(year = rownames(bering_sea), 
                         ParHat$x_tj) %>% 
  pivot_longer(!year, names_to = "var", values_to = "predicted")

pred_sd <- data.frame(year = rownames(bering_sea),
                      as.list(fit$sdrep,what="Std.")$x_tj) %>% 
  pivot_longer(!year, names_to = "var", values_to = "SD")

pred_all <- raw_dat %>% 
  left_join(pred_model, by = join_by(year, var)) %>% 
  left_join(pred_sd, by = join_by(year, var)) %>% 
  mutate(lower = predicted - ifelse(is.na(SD), 0, SD),
         upper = predicted + ifelse(is.na(SD), 0, SD),
         year = as.numeric(year)) 

ggplot(pred_all, aes(x = year, y = predicted, ymin = lower, ymax = upper, group = var)) +
  geom_path() +
  geom_ribbon(alpha = 0.2, color = "blue", fill = "blue") +
  geom_point(aes(x = year, y = value)) +
  facet_wrap(~var) +
  scale_x_continuous(limits = c(1963, 2025), breaks = seq(1955, 2025, 10)) +
  theme_minimal() +
  labs(x = "", y = "",
       title = "",
       subtitle = "") +
  NULL

```



```{r dsem_dag, eval=FALSE, include=FALSE}


p1 = plot( (as_fitted_DAG(fit)), edge.width=1, type="width",
           text_size=4, show.legend=FALSE,
           arrow = grid::arrow(type='closed', 18, grid::unit(10,'points')) ) +
     scale_x_continuous(expand = c(0.4, 0.1))
p1$layers[[1]]$mapping$edge_width = 1
p2 = plot( (as_fitted_DAG(fit, what="p_value")), edge.width=1, type="width",
           text_size=4, show.legend=FALSE, colors=c('black', 'black'),
           arrow = grid::arrow(type='closed', 18, grid::unit(10,'points')) ) +
     scale_x_continuous(expand = c(0.4, 0.1))
p2$layers[[1]]$mapping$edge_width = 0.5
p1/p2


#grid.arrange( arrangeGrob( p0+ggtitle("timeseries"),
#              arrangeGrob( p1+ggtitle("Estimated path diagram"),
#                           p2+ggtitle("Estimated p-values"), nrow=2), ncol=2 ) )
# ggarrange(p1, p2, labels = c("Simultaneous effects", "Two-sided p-value"),
#                     ncol = 1, nrow = 2)


```