---
title: "Causal model of S. Benguela"
author: "Scott Large"
output: 
  bookdown::html_document2:
    code_folding: hide
    number_sections: false
date: "`r format(Sys.time(), '%d %B, %Y')`"
editor_options: 
  chunk_output_type: console
bibliography: references.bib
reference-section-title: References
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=12, warning = FALSE, message = FALSE)
```

```{r load_dat}
# if (!require("BiocManager", quietly = TRUE)) install.packages("BiocManager")
# BiocManager::install("graph")
# devtools::install_github( "James-Thorson-NOAA/dsem@dev", force=TRUE )

## Find all the code here:
# https://github.com/ScottLarge-NOAA/mission_atlantic

library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(lubridate)
# install.packages("dsem")
library(dsem) ## 1.3.0
library(phylopath)

all_dat <- readRDS(here::here("data/all_dat.rds"))
benguela_nino <- readRDS(here::here("data/bni.rds"))

agulhas_gradient <- readRDS(file = here::here("data/agulhas_gradient.rds"))
pressure <- readRDS(file = here::here("data/pressure.rds"))
cap_anomaly <- readRDS(file = here::here("data/cap_anomaly.rds"))
tsa <- readRDS(file = here::here("data/tsa.rds"))
upwelling <- readRDS(here::here("data/upwelling_index.rds"))
catches <- readRDS(here::here("data/pelagic_catch.rds"))
catches_m <- readRDS(here::here("data/pelagic_catch_monthly.rds"))
recruitment <- readRDS(here::here("data/pelagic_recruitment.rds")) %>% 
  filter(unit == "n")
biomass <- readRDS(here::here("data/pelagic_biomass.rds")) %>%
  filter(indicator == "biomass")
cal_tab <- readRDS(here::here("data/calendar_table.rds"))
ltl_dat <- readRDS(here::here("data/ltl_dat.rds"))
summer_sst <- readRDS(here::here("data/summer_sst.rds"))
```

```{r remote_dat}
ag_plot <- ggplot(agulhas_gradient, aes(x = date, y = sst_gradient))+
  geom_path() + 
  geom_point() +
  theme_minimal() +
  scale_x_date(date_breaks = "5 years",
               date_labels = "%Y") +
  labs(title = "Agulhas cross-shelf gradient", 
       subtitle = "Central Agulhas Bank Offshore SST - Central Agulhas Bank Coastal SST",
       x = "",
       y = "")
# ag_plot

pres_plot <- ggplot(pressure,aes(x = date, y = pressure), show.legend = FALSE) +
  geom_path()+
  geom_point()+
  theme_minimal() +
  scale_x_date(date_breaks = "5 years",
               date_labels = "%Y") +
  labs(title = "Atmospheric pressure (hPa)",
       subtitle = "NCEP/NCAR Reanalysis",
       x = "",
       y = "")
# pres_plot

cap_plot <- ggplot(cap_anomaly) +
  geom_bar(aes(x = date, y = cap_anomaly, fill = col), stat = "identity", show.legend = FALSE)+
  geom_hline(yintercept = 0, linewidth = .75) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme_minimal() +
  scale_x_date(date_breaks = "5 years",
               date_labels = "%Y") +
  scale_fill_manual(values = c("blue", "red")) +
  labs(title = "Standardized Cape Agulhas Pressure (CAP) anomaly",
       x = "",
       y = "")
# cap_plot

tsa_plot <- ggplot(tsa, aes(x = year, y = proportion)) +
  geom_path() +
  geom_point() +
  theme_minimal() +
  labs(x = "", y = "",
       title = "Thermal Spawning Area index",
       subtitle = "proportion of Agulhas Bank SST within 16–19°C during September and October") +
  NULL
# tsa_plot

sst_wide <- summer_sst %>% 
  pivot_wider(names_from = variable, values_from = mean)

sst_plot <- ggplot(summer_sst, aes(x = year, y = mean, color = variable)) +
  geom_path() +
  geom_point() +
  theme_minimal() +
  labs(x = "", y = "",
       title = "Mean temperature (°C)",
       subtitle = "December-February OISST") +
  NULL
# sst_plot

```

```{r upwelling_dat}
upwelling_wide <- upwelling %>% 
  pivot_wider(names_from = variable, values_from = value)

up_summer <- ggplot(upwelling, aes(x = year, y = value/1000, color = variable)) +
  geom_path() +
    geom_point() + 
  scale_x_continuous(limits = c(1979, 2020), breaks = seq(1965, 2020, 5)) +
  labs(x = "", y = "", color = "",
       title = "Upwelling index",
       subtitle = bquote("December-February cumulative upwelling"~(m^3~s^-1~100~m^-1)~x~1000)) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL
# up_summer

```

```{r pp_dat}
pp_wide <- ltl_dat %>% 
  select(year, chla_SB, chla_AB, chlaship_AB, pico_SB, pico_AB, nano_SB, nano_AB, micro_SB, micro_AB)

pp_dat <- ltl_dat %>% 
  select(year, chla_SB, chla_AB) %>% 
  pivot_longer(-year, names_to = "name", values_to = "value") %>% 
  separate_wider_delim(cols = "name", delim = "_", names = c("name", "area")) %>% 
  mutate(area = ifelse(area == "AB", "Agulhas Bank", "Southern Benguela"))

pp_plot <- ggplot(pp_dat, aes(x = year, y = value, color = area)) +
  geom_point() + 
  geom_path() +
  scale_x_continuous(limits = c(1978, 2020), breaks = seq(1965, 2020, 5)) +
  labs(x = "", y = "", color = "",
       title = bquote("Seasonal mean chlorophyll"~italic(a)),
       subtitle = bquote("December-February"~(mg~m^-3))) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL
# pp_plot

pp_size <- ltl_dat %>% 
  select(year, pico_SB, pico_AB, nano_SB, nano_AB, micro_SB, micro_AB) %>% 
  pivot_longer(-year, names_to = "name", values_to = "value") %>% 
  separate_wider_delim(cols = "name", delim = "_", names = c("name", "area")) %>% 
  mutate(area = ifelse(area == "AB", "Agulhas Bank", "Southern Benguela"))

pp_size_plot <- ggplot(pp_size, aes(x = year, y = value, color = name)) +
  facet_wrap(~area, nrow = 2) +
  geom_point() + 
  geom_path() +
  scale_x_continuous(limits = c(1978, 2020), breaks = seq(1965, 2020, 5)) +
  scale_y_continuous(limits = c(0, 1)) +
  labs(x = "", y = "", color = "",
       title = bquote("Seasonal mean fractional contribution to chlorophyll"~italic(a)),
       subtitle = bquote("December-February"~(mg~m^-3))) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL
# pp_size_plot
```

```{r zoop_dat}
zoop_wide <- data.frame(year = seq(min(ltl_dat$year, na.rm = TRUE),
                            max(ltl_dat$year, na.rm = TRUE), 1)) %>% 
  left_join(ltl_dat) %>% 
  select(year, copepodabund_SB, accs_SB, mdlgzp_SB, smallzp_SB, copepod_AB, calanus_AB, smcopepod_AB)

zoop_dat <- data.frame(year = seq(min(ltl_dat$year, na.rm = TRUE),
                                  max(ltl_dat$year, na.rm = TRUE), 1)) %>% 
  left_join(ltl_dat) %>% 
  select(year, copepodabund_SB,accs_SB, mdlgzp_SB, smallzp_SB, copepod_AB, calanus_AB, smcopepod_AB) %>% 
  pivot_longer(-year, names_to = "name", values_to = "value", values_drop_na = FALSE) %>% 
  separate_wider_delim(cols = "name", delim = "_", names = c("name", "area"))

zoop_sb <- zoop_dat %>% 
  filter(area == "SB") %>% 
  mutate(name = case_when(name == "mdlgzp" ~ "zooplankton_ML",
                          name == "smallzp" ~ "zooplankton_S",
                          name == "copepodabund" ~ "copepod_all",
                          TRUE ~ name),
         unit = factor(case_when(grepl("zoop", name) ~ "biomass",
                                 grepl("cope", name) ~ "abundance",
                                 grepl("accs", name) ~ "accs",
                                 TRUE ~ NA_character_), levels = c("biomass", "abundance", "accs"), 
                       labels = c("biomass~anomaly", bquote("copepod abundance"~log(~n~m^-2~+~1)), 
                                  "ACCS~index~(mm)")))

zoop_sb_plot <- ggplot(zoop_sb, aes(x = year, y = value, color = name)) +
  facet_wrap(~unit, scale = "free_y", ncol = 1, labeller = label_parsed) +
  geom_path() +
  geom_point() + 
  scale_x_continuous(limits = c(1950, 2020), breaks = seq(1950, 2020, 10)) +
  labs(x = "", y = "", color = "",
       title = "Zooplankton indicators",
       subtitle = "Southern Benguela") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL
# zoop_sb_plot

zoop_ab <- zoop_dat %>% 
  filter(area == "AB") %>% 
  mutate(area = ifelse(area == "AB", "Agulhas Bank", "Southern Benguela"))

zoop_ab_plot <- ggplot(zoop_ab, aes(x = year, y = value, color = name)) +
  geom_path() +
  geom_point() + 
  scale_x_continuous(limits = c(1950, 2020), breaks = seq(1950, 2020, 10)) +
  labs(x = "", y = "", color = "",
       title = bquote("Mean integrated zooplankton biomass"~(mg~C~m^-2)),
       subtitle = "Agulhas Bank") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL
# zoop_ab_plot
```

```{r recruits}

rec1 <- ggplot(recruitment %>% filter(species!= "Roundeye Herring"), aes(x = year, y = value, group = species, color = species)) +
  geom_path() +
  geom_point() + 
  scale_x_continuous(limits = c(1979, 2021), breaks = seq(1965, 2020, 5)) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "",
       y = "",
       title = "small pelagic recruitment",
       subtitle = "autumn/winter (May/June) acoustic survey (billions)") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL
    # rec1
```

```{r biomass}

bio1 <- ggplot(biomass %>% filter(species != "Roundeye Herring"), aes(x = year, y = value, group = species, color = species)) +
  facet_wrap(~ factor(area, levels = c("east", "west", "total")), ncol = 1) +
  geom_path() +
  geom_point() + 
  scale_color_brewer(palette = "Set2") +
  scale_x_continuous(limits = c(1979, 2020), breaks = seq(1965, 2020, 5)) +
  labs(x = "",
       y = "",
       title = "small pelagic spawner biomass",
       subtitle = "spring/summer (October/November) acoustic survey (million tonnes)") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL

```

```{r logspr}
logrps <- biomass %>% 
  filter(tolower(species) != "roundeye herring",
         area == "total") %>% 
  select(-area, -indicator, biomass = value) %>% 
  left_join(
    recruitment %>% 
      filter(tolower(species) != "roundeye herring") %>% 
      select(year, species, recruits = value),
    by = join_by(year, species)) %>% 
  group_by(year, species) %>%  
  mutate(recruits = recruits * 1e9,
         biomass = biomass * 1000,
         rps = recruits/biomass,
         log_rps = log(recruits / biomass))

logrps_plot <- ggplot(logrps, aes(x = year, y = log_rps, group = species, color = species)) +
  geom_path() +
  geom_point() + 
  scale_color_brewer(palette = "Set2") +
  scale_x_continuous(limits = c(1979, 2020), breaks = seq(1965, 2020, 5)) +
  labs(x = "",
       y = "",
       title = "small pelagic survival",
       subtitle = "log(recruit/biomass)") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL
# logrps_plot

rps_wide <- logrps %>% 
  select(-recruits, -rps) %>% 
  pivot_wider(names_from = species, values_from = c(biomass, log_rps))
```

```{r pel_catch}

sp_plot <- ggplot(catches %>% filter(species != "Roundeye Herring"), aes(x = year, y = value/1000, group = species, fill = species, color = species)) +
  geom_path() +
    geom_point() + 
  # geom_bar(stat = "identity") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = "", y = "",
       title = "small pelagic catches",
       subtitle = "tonnes (thousands)") +
  NULL

```

```{r sardine_month}

sardine_d <- catches_m %>% 
  filter(species == "sardine") %>% 
  select(-species) %>% 
  pivot_longer(Jan:Dec, names_to = "month", values_to = "value") %>% 
  mutate(month = factor(month.name[match(.$month, month.abb)], levels = month.name[c(6:12, 1:5)]),
         year = factor(year),
         table = case_when(table == "1a" ~ "directed fishery west of Cape Agulhas",
                           table == "1b" ~ "directed fishery east of Cape Agulhas",
                           table == "1c" ~ "bycatch with anchovy fishery",
                           TRUE ~ NA_character_)) 


sard1 <- ggplot(sardine_d, aes(x = month, y = year, height = value, group = year, fill = table)) +
  ggridges::geom_density_ridges(stat = "identity", scale = 3, alpha = 0.4, show.legend = FALSE) +
  facet_wrap(~table, ncol = 3) +
  labs(x = "", y = "",
       title = "distribution of monthly sardine commercial catches") +
  coord_cartesian(clip = "off") +
  theme_minimal() +
  theme(axis.text.y = element_text(vjust = 0),
        axis.text.x = element_text(angle = 45, vjust = .5)) +
  NULL
```

```{r anchovy_month}

anchovy_d <- catches_m %>% 
  filter(species == "anchovy") %>% 
  select(-species, -table) %>% 
  pivot_longer(Jan:Dec, names_to = "month", values_to = "value") %>% 
  mutate(month = factor(month.name[match(.$month, month.abb)], levels = month.name[c(6:12, 1:5)]),
         year = factor(year)) 


anch1 <- ggplot(anchovy_d, aes(x = month, y = year, height = value, group = year)) +
  ggridges::geom_density_ridges(stat = "identity", scale = 3, fill = "purple", alpha = 0.4, show.legend = FALSE) +
  # facet_wrap(~table, ncol = 3) +
  labs(x = "", y = "",
       title = "distribution of monthly anchovy commercial catches") +
  coord_cartesian(clip = "off") +
  theme_minimal() +
  theme(axis.text.y = element_text(vjust = 0),
        axis.text.x = element_text(angle = 45, vjust = .5)) +
  NULL

```

```{r calendar_table}
month_ord <- month.name[c(7:12, 1:6)]
# paste("'", cal_tab$process, "'", collapse = ", ", sep =)
process_ord <- c('Upwelling (SB)', 'Upwelling (AB)', 'Sea-surface temperature (AB)', 'Sea-surface temperature (SB)', 
                 'Thermal spawning area (AB)', 'Cross-shelf Temperature gradient (AB)', 'Cape Agulhas Pressure (AB)', 
                 'Chl a concentration (AB)', 'Chl a concentration (SB)', 'Zooplankton biomass (AB)', 
                 'Zooplankton abundance (SB)', 'Zooplankton composition (SB)', 'Sardine recruitment survey (SB)',
                 'Anchovy recruitment survey (SB)', 'Sardine biomass survey (AB)', 'Anchovy biomass survey (AB)',
                 'Sardine bycatch', 'Anchovy catch', 'Sardine catch')

seasons <- data.frame(xstart = seq(0.5, 9.5, 3), xend = seq(3.5, 12.5, 3), 
                      season = factor(c("winter", "spring", "summer", "autumn"),
                                   levels = c("winter", "spring", "summer", "autumn")))

all_cal <- cal_tab %>% 
  mutate(year = ifelse(month_start > month_end, 2019, 2020),
         month_end = as.Date(sprintf("2020-%s-01", month_end)),
         month_start = as.Date(sprintf("%s-%s-01", year, month_start)),
         process = factor(process, levels = process_ord)) %>% 
  group_by(process) %>% 
  tidyr::complete(month_start = seq(month_start, month_end, by = "month")) %>% 
  tidyr::fill(lag, .direction = "down") %>% 
  select(process, month = month_start, lag) %>% 
  mutate(month = factor(lubridate::month(month, label = TRUE, abbr = FALSE),
                        levels = month_ord))

timeline_plot <- ggplot() +
  geom_rect(data = seasons, aes(xmin = xstart, xmax = xend, 
                                ymin = -Inf, ymax = Inf, fill = season), alpha = 0.4) +
  geom_point(data = all_cal, aes(x = month, y = process, color = as.factor(lag)), size = 5) +
  scale_color_manual(values = c("black", "red", "blue")) +
  theme_minimal() +
  labs(x = "", y = "", 
       color = "lag",
       title = "Timeline for important Southern Benguela processes",
       subtitle = "Lags indicate events in the current year (T = 0) that are affected in year T+lag") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, vjust = .5))
# timeline_plot
```

# Introduction ---

-   IEA as tool for confronting trade-offs between multiple EBM objectives [@levin2009; @skein2022].
-   Causal models help to identify the magnitude and direction of direct and indirect effects between interacting variables [**SL** find a few citations within @thorson2024].
-   Identifying meaningful indicators is important for EBFM [@rice2005].
-   Southern Benguela is an important and dynamic system. Scoping exercises identified fishing as the sector with the greatest connectivity and risk among South African ocean-use sectors [@skein2022]. Anchovy *Engraulis* *encrasicolus* and sardine *Sardinops sagax* are critical commercial and ecologically important small pelagic fish in South Africa [@vanderlingen2021].
-   Here we develop a novel causal model to explore how the environment influences ecosystem indicators with the ultimate goal of disentangling multiple drivers of ecosystem change to evaluate indicators for potential use within an IEA framework.

# Methods ---

## Model area

-   *TO DO* Create map with the relevant spots identified (Figure 1)

## Data ---

-   Environmental Indicators
    -   Increasing SST may influence plankton community structure [@huggett2023], where increased temperatures would result in smaller-bodied communities that might favor sardine
        -   Mean sea temperature (°C) near the surface (5 m depth) [@huggett2023] (SST, see Figure \@ref(fig:sst-plot))
    -   Cross-shelf (SST) gradient off the south coast might be correlated with the percentage of anchovy biomass east of Cape Agulhas [@roy2007; @augustyn2017].
        -   Agulhas cross-shelf gradient (AG, see Figure \@ref(fig:ag-plot))
    -   Anchovy spawning distribution shifted as a result of environmental forcing [@roy2007].
        -   Decadal signal in atmospheric pressure seen in NCEP/NCAR reanalysis data (pressure, see Figure \@ref(fig:pres-plot)
    -   Larval anchovy foraging conditions seem to be optimal in 16-19°C water (plankton production and the consistency of copepod biomass). A positive linear relationship has been found between egg abundance and the area of 16--19°C water over the western Agulhas Bank [@richardson1998].
        -   Anchovy thermal spawning area index - (TSA, see Figure \@ref(fig:tsa-plot))
    -   The Agulhas Bank (AB) is ecologically and economically important since it comprises the major spawning grounds for numerous fish species which recruit to the west coast [@hutchings2009; @kirkman2016]. Efficient transport between the spawning grounds and the nursery area is critical for recruitment success [@agenbag1996]. Increased wind velocity (high CAP index) over the anchovy transport area (Cape Point to Cape Columbine) is likely to result in improved transport. A high CAP anomaly for September--December should result in more efficient transport to the productive nursery grounds.
        -   Cape Agulhas pressure anomaly index (CAP, see Figure \@ref(fig:cap-plot))
    -   Increased wind that drives upwelling also increases surface water advection offshore, which may decrease survival of early life history stages of small pelagic species during their transport from spawning grounds to the west coast nursery area [@augustyn2017].
    -   Larger zooplankton may be more abundant when upwelling is stronger and smaller zooplankton may be more abundant when upwelling is weaker, which could suggest that sardine diet is negatively influenced by upwelling [@vanderlingen2006].
        -   Cumulative coastal South Benguela and Agulhas Bank upwelling from December to March [@lamont2018]. Upwelling index - (see Figure \@ref(fig:upsummer-plot))
-   Ecosystem responses:
    -   Southern Benguela -
        -   Mean chlorophyll a (mg m-3) from December to February (chla_SB) [@lamont2019]
        -   Mean fractional contribution of microphytoplankton (micro_SB), nanophytoplankton (nano_SB), and picophytoplankton (pico_SB) from December to February [@lamont2019]
    -   Agulhas Bank -
        -   Mean chlorophyll a (mg m-3) from December to February [@lamont2019]
        -   Mean fractional contribution of microphytoplankton (micro_AB), nanophytoplankton (nano_AB), and picophytoplankton (pico_AB) from December to February (chla_AB) [@lamont2019]
        -   *in situ* Mean chlorophyll a (mg m\^-3) near the surface (5 m depth) from March to May @huggett2023
    -   Wind-driven upwelling at discrete upwelling centers in the southern Benguela is strongly pulsed and shows greater seasonal differences, with a narrow band of high plankton productivity in the southern part, restricted to the narrow coastal zone by warm Agulhas water offshore forming a front.
    -   Close relationship is to be expected between primary production and upwelling of nutrient-rich water over short time scales, it is generally assumed that long-term shifts in upwelling-favorable winds will lead to changes in upwelling and, consequently, to changes in phytoplankton production and biomass on similar scales (Hampton, 2012). However, patterns observed from in situ and satellite data provide no clear indications to suggest that such a straight-forward link between primary production and upwelling variability occurs in the Benguela, but there is evidence of substantial interannual and decade-scale changes in both phytoplankton production and upwelling at a number of times and locations in both the northern and southern Benguela sub-systems [@verheye2016].
        -   Seasonal mean chlorophyl *a* (mg m\^-3; see Figure \@ref(fig:pp-plot)))
-   Zooplankton
    -   Anchovy
        -   Significant relationship between Agulhas Bay *Calanus* *agulhensis* and anchovy biomass [@huggett2023].
    -   Sardine
        -   \-@huggett2023 didn't find any significant relationships between copepod and sardine biomass.
    -   Southern Benguela -
        -   Zooplankton samples collected in St. Helena Bay between 1951 and 1996, specifically during austral autumn (April-June), when peak recruitment of anchovy and sardine occurs, were analysed in terms of abundance, species and size composition of the copepod community following a standard, quantitative protocol [see @verheye1998]
        -   zooplankton biomass anomaly by species and size composition from November and December (small zooplankton = smallzp_SB, medium and large copepods = mdlgzp_SB; Huggett 2009), copepod abundance (log(n m\^-2 +1) and Average Copepod Community Size index (ACCS) [@verheye2016]
    -   Agulhas Bank -
        -   Mean integrated total copepod biomass (mg C m-2) in the upper 200 m of the water column (total_mgC_m2) [@huggett2023]
        -   Mean integrated biomass (mg C m\^-2) of Calanus agulhensis (all stages) in the upper 200 m of the water column (Cal_mgC_m2)[@huggett2023]
        -   Mean integrated biomass (mg C m\^-2) of small calanoid copepods (mainly Paracalanidae and Clausocalanidae) in the upper 200 m of the water column (SmCal_mgC_m2) [@huggett2023]
        -   Mean integrated biomass (mg C m\^-2) of Oithonidae in the upper 200 m of the water column (Oithona_mgC_m2) [@huggett2023]
        -   Mean integrated biomass (mg C m\^-2) of Oncaeidae in the upper 200 m of the water column (Oncaea_mgC_m2) [@huggett2023]
    -   Small Pelagic dynamics
        -   Recruitment surveys occur between April and June
            -   Sardine recruits (FISHERIES/2021/JUL/SWG-PEL/51 Table 2)
            -   Anchovy recruits (FISHERIES/2021/JUL/SWG-PEL/51 Table 2)
                -   see Figure \@ref(fig:rec-plot)
        -   Spawning-stock biomass
            -   Biomass surveys occur between October and November
            -   Sardine biomass (FISHERIES/2020/DEC/SWG-PEL/130rev2 Table 2)
            -   Anchovy biomass (FISHERIES/2020/DEC/SWG-PEL/130rev2 Table 2)
            -   see Figure \@ref(fig:bio-plot)
        -   Survival
            -   log(recruit/biomass) see Figure \@ref(fig:logrps-plot)
-   Fishing
    -   Small pelagic directed and bycatch
        -   see Figure \@ref(fig:catch-plot)
    -   temporal patterns in sardine fishery
        -   see Figure \@ref(fig:sard1-plot)
    -   temporal patterns in sardine fishery
        -   see Figure \@ref(fig:anch1-plot)

Environmental drivers and ecosystem response variables (see Figures \@ref(fig:z-plot) and \@ref(fig:timeline-plot))

```{r dsem_data, warning=FALSE, message=FALSE}

sem_dat_long <- data.frame(year = 1950:2023) %>% 
  left_join(upwelling_wide) %>% 
  left_join(cap_anomaly %>% select(-date, -col, cap = cap_anomaly)) %>% 
  left_join(tsa %>% select(-area, -spawner_area, tsa = proportion)) %>% 
  left_join(agulhas_gradient %>% select(agulhas_gradient = sst_gradient, year)) %>% 
  left_join(sst_wide) %>% 
  left_join(pp_wide) %>% 
  left_join(zoop_wide) %>% 
  left_join(rps_wide) %>% 
  left_join(catches %>% 
              select(year, species, value) %>% 
              pivot_wider(names_from = species, names_glue = "{tolower(gsub(' ', '_', species))}_catches", values_from = value)) %>% 
  pivot_longer(-year, names_to = "var", values_to = "val") %>% 
  group_by(var) %>% 
## Remove roundeye for now
  mutate(val = scale(val, scale = TRUE, center = TRUE)[,1]) %>% 
  # filter(!stringr::str_detect(var, "roundeye|_east|_west"))
    filter(!stringr::str_detect(var, "roundeye|_total")) 

sem_dat <- sem_dat_long %>% 
  pivot_wider(names_from = var, values_from = val) 

zplot <- ggplot(sem_dat_long, aes(x = year, y = val, group = var, color = var)) +
  geom_path(show.legend = FALSE) +
  gghighlight::gghighlight(unhighlighted_params = list(alpha = 0.4)) +
  facet_wrap(~var, ncol = 3) +
  labs(x = "", y = "z-score", color = "",
       title = "Indicators used in dsem analysis") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  NULL
# 
# zplot
# 
# timeline_plot
```

```{r, z-plot, fig.cap= "All indicators"}
zplot
```

```{r, timeline-plot, fig.cap= "Temporal dynamics of indicators"}
timeline_plot
```

```{r, include=TRUE, fig.cap = "test", include=FALSE}

# ag_plot
# pres_plot
# cap_plot
# tsa_plot
# # bni_m / bni_s
# up_summer
# pp_plot
# zoop_ab_plot
# zoop_sb_plot
# rec1
# bio1
# sp_plot
# sard1
# anch1

```

## Causal modeling ---

<!-- * Initial conceptual model is taken from ODEMM/IEA process (Skein et al 2022 and Bornman et al 2024) -->

-   Dynamic Structural Equation Model (Thorson et al 2024)

# Results ---

-   Simultaneous effects
    -   Upwelling has a significant positive relationship with large phytoplankton and a negative relationship with small phytoplankton.
    -   Large and small phytoplankton have significant positive relationships with all zooplankton size classes, but the largest effect size is between large phytoplankton and macrozooplankton and small phytoplankton and mesozooplankton.
    -   Benguela Nino has a negative relationship with sardine recruits.
-   Lag 1 (X in time T affects Y in time T+1)
    -   Microplankton have a significant positive relationship with both anchovy and sardine recruits
    -   Sardine recruits have a significant positive relationship with sardine total biomass, whereas anchovy does not have a strong relationship between recruits and biomass
        -   Anchovy catches don't have a strong relationship with sardine biomass (maybe think about area/regional effects)
-   Lag 3 (X in time T affects Y in time T+3)
    -   Sardine biomass has a significant positive relationship with sardine catches

```{r dag_full, include=FALSE}
dag_full <- phylopath::DAG(chla_SB~upwelling_SB,
                           chla_AB~upwelling_AB,
                           chla_SB~sst_SB,
                           chla_AB~sst_AB,
                           copepod_AB~chla_AB,
                           calanus_AB~chla_AB,
                           smcopepod_AB~chla_AB,
                           mdlgzp_SB~chla_SB,
                           copepodabund_SB~chla_SB,
                           smallzp_SB~chla_SB,
                           accs_SB~chla_SB,
                           log_rps_Anchovy~mdlgzp_SB,
                           log_rps_Sardine~smallzp_SB,
                           biomass_Anchovy~calanus_AB,
                           biomass_Sardine~chla_AB, 
                           biomass_Sardine~chla_SB,
                           biomass_Sardine~smcopepod_AB,
                           log_rps_Anchovy~biomass_Anchovy,
                           log_rps_Sardine~biomass_Sardine,
                           biomass_Anchovy~catches_Anchovy,
                           biomass_Sardine~catches_Anchovy,
                           biomass_Sardine~catches_Sardine)




df_plot <- plot(dag_full, edge_width = 1, type="width",
                text_size = 4, show.legend = FALSE, box_x = 12) +
  scale_x_continuous(expand = c(0.05, 0.05)) +
  labs(title = "directed acyclic graph - full") +
  NULL

df_plot
```

-   Still need to figure out how to characterize the lags in the DAG

```{r sem_full}
# colnames(sem_dat)
sem_dat_full <- sem_dat %>% 
  select(year, 
         upwelling_AB, upwelling_SB, tsa, cap, agulhas_gradient, sst_AB, sst_SB, ## environmental drivers
         chla_SB, chla_AB, chlaship_AB,## primary production
         # pico_SB, pico_AB, nano_SB, nano_AB, micro_SB, micro_AB, ## phytoplankton size
         copepodabund_SB, accs_SB, mdlgzp_SB, smallzp_SB, copepod_AB, calanus_AB, smcopepod_AB, # zooplankton community     
         biomass_Anchovy, biomass_Sardine, log_rps_Anchovy, log_rps_Sardine) %>% #,## fish
         # anchovy_catches, sardine_catches) %>% ## removals
  as.data.frame()
```

```{r sem_simple_dat}

## guidance from ??make_dsem_ram()
### X -> Y, 1, XtoY indicates that X in time T affects Y in time T+1)
### X -> Y, 0, XtoY indicates X affects Y simultaneously (lag=0) 

# Specify model
sem_simple <- "
  # Link, lag, param_name (NA = off), fixed value (optional, 1 if param is off)
  
  ## AB environment mediates primary production
  upwelling_AB -> chla_AB, 0, upwelling_to_ppAB
  # sst_AB -> chla_AB, 0, sst_to_ppAB

  ## SB environment mediates primary production
  # upwelling_SB -> chla_SB, 0, upwelling_to_ppSB
  # sst_SB -> chla_SB, 0, sst_to_ppSB

  ## AB Trophic links between PP and zooplankton
  chla_AB -> calanus_AB, 0, chla_to_calanusAB
  chla_AB -> copepod_AB, 0, chla_to_copepodAB
  # chla_AB -> smcopepod_AB, 0, chla_to_smallcopepodAB
 
  ## SB Trophic links between PP and zooplankton
  chla_SB -> mdlgzp_SB, 0, chla_to_largezpSB
  # chla_SB -> copepodabund_SB, 0, chla_to_copeopodabundSB
  chla_SB -> smallzp_SB, 0, chla_to_smallzpSB
  # chla_SB -> accs_SB, 0, chla_to_accsSB

  # ## AR
  # upwelling_SB -> upwelling_SB, 1, AR1, 0.001
  upwelling_AB -> upwelling_AB, 1, AR2, 0.001
  # sst_SB -> sst_SB, 1, AR3, 0.001
  # sst_AB -> sst_AB, 1, AR4, 0.001
   
  chla_AB -> chla_AB, 1, AR5, 0.001
  calanus_AB -> calanus_AB, 1, AR7, 0.001
  # smcopepod_AB -> smcopepod_AB, 1, AR8, 0.001
  copepod_AB -> copepod_AB, 1, AR9, 0.001

  chla_SB -> chla_SB, 1,  AR10, 0.001
  mdlgzp_SB -> mdlgzp_SB, 1, AR11, 0.001
  smallzp_SB -> smallzp_SB, 1, AR12, 0.001
  # copepodabund_SB -> copepodabund_SB, 1, AR13, 0.001
  # accs_SB -> accs_SB, 1, AR14, 0.001

#### ---
"
sem_dat_simple <- sem_dat_full %>% 
  select(year, upwelling_AB, 
         # sst_AB,
         chla_SB, chla_AB,
         # chlaship_AB,
         # upwelling_SB, sst_SB,
         # cap, tsa, agulhas_gradient,
         # copepodabund_SB,
         # accs_SB,
         # smcopepod_AB,
         calanus_AB,
         copepod_AB,
         mdlgzp_SB, smallzp_SB,
       # log_rps_Anchovy, log_rps_Sardine, biomass_Anchovy, biomass_Sardine
       ) %>% 
   filter(!if_all(-year, is.na)) %>% 
  filter(year >= 1985) %>%
  as.data.frame()

rownames(sem_dat_simple) <- sem_dat_simple$year
sem_dat_simple <- sem_dat_simple[,-1]


# Fit dsem
fit_simple <- dsem( sem = sem_simple,
            tsdata = ts(sem_dat_simple),
            family =  rep('fixed', ncol(sem_dat_simple)),
            control = dsem_control(use_REML = TRUE, quiet=TRUE))
ParHat_simple = fit_simple$obj$env$parList()

summary_simple <- summary(fit_simple) %>% 
  mutate(sig = cut(p_value, breaks = c(-Inf, 0.01, 0.05, 0.10, Inf), 
                   labels = c("***", "**", "*", "NS")))
AIC(fit_simple)

# AIC(fit_full)
# 1551.142
# 1548
# 1545
# 1543

```

```{r dsem_simple_dag, fig.height = 12, fig.width = 15}

lags_simple <- data.frame(summary(fit_simple)) %>% 
  filter(!grepl("^AR.*|^V\\[.*", name)) %>% 
  pull(lag) %>% 
  unique()

# lags_simple <- unique(as.numeric(summary(fit_simple)$lag))


# i = 0
for(i in lags_simple){
  
  p1_simple <- NULL
  p2_simple <- NULL

  p1_simple <- plot( (as_fitted_DAG(fit_simple, lag = i)), edge_width = 1, type="width",
                      text_size = 4, show.legend = FALSE, box_x = 12) +
    scale_x_continuous(expand = c(0.05, 0.05)) +
    labs(title = sprintf("lag %s effects", i)) +
    NULL

  p1_simple <- ggplot_build(p1_simple)
  p1_simple$data[[1]]$edge_width <- 1
  
  
  p2_simple <- plot( (as_fitted_DAG(fit_simple, what="p_value", lag = i)), #edge_width = 2, 
                      type = "width",
                      text_size = 4, show.legend = FALSE, colors=c('black', 'black'), 
                      box_x = 12) +
    scale_x_continuous(expand = c(0.05, 0.05)) +
    labs(title = sprintf("Two-sided p-value (lag %s)", i)) +
    NULL
  
  
  p2_simple <- ggplot_build(p2_simple)
  p2_simple$data[[1]]$edge_width <- 1
  
  print(wrap_ggplot_grob(ggplot_gtable(p1_simple))/wrap_ggplot_grob(ggplot_gtable(p2_simple)))
}

```

```{r dsem_simple_ts, warning=FALSE, message=FALSE}

# Timeseries plot
raw_dat_simple <- data.frame(year = rownames(sem_dat_simple), 
                         sem_dat_simple) %>% 
  pivot_longer(!year, names_to = "var", values_to = "value")

pred_model_simple <- data.frame(year = rownames(sem_dat_simple), 
                         ParHat_simple$x_tj) %>% 
  pivot_longer(!year, names_to = "var", values_to = "predicted")

pred_sd_simple <- data.frame(year = rownames(sem_dat_simple),
                      as.list(fit_simple$sdrep,what="Std.")$x_tj) %>% 
  pivot_longer(!year, names_to = "var", values_to = "SD")

pred_all_simple <- raw_dat_simple %>% 
  left_join(pred_model_simple, by = join_by(year, var)) %>% 
  left_join(pred_sd_simple, by = join_by(year, var)) %>% 
  mutate(lower = predicted - ifelse(is.na(SD), 0, SD),
         upper = predicted + ifelse(is.na(SD), 0, SD),
         year = as.numeric(year)) 

ts_plot_simple <- ggplot(pred_all_simple, aes(x = year, y = predicted, ymin = lower, ymax = upper, group = var)) +
  geom_path() +
  geom_ribbon(alpha = 0.2, color = "blue", fill = "blue") +
  geom_point(aes(x = year, y = value)) +
  facet_wrap(~var) +
  scale_x_continuous(limits = c(1979, 2020), breaks = seq(1965, 2020, 5)) +
  theme_minimal() +
  labs(x = "", y = "",
       title = "Estimated values",
       subtitle = "measurements (black dots), predicted values (blue lines), and 95% predictive intervals (\u00B11.96 SE)") +
  NULL
ts_plot_simple
```

```{r dsem_simple_resid, warning=FALSE, message=FALSE}

simple_sample <- dsem::loo_residuals(fit_simple, what="samples", track_progress=FALSE)
which_use = which(!is.na(sem_dat_simple))
fittedPredictedResponse = loo_residuals(fit_simple, what="loo", track_progress=FALSE)
res = DHARMa::createDHARMa( simulatedResponse = apply(simple_sample,MARGIN=3,FUN=as.vector)[which_use,],
                            observedResponse = unlist(sem_dat_simple)[which_use],
                            fittedPredictedResponse = fittedPredictedResponse$est )
plot(res)

```

```{r sem_dat_full}
# colnames(sem_dat)
sem_dat_full <- sem_dat %>% 
  select(year, 
         upwelling_AB, upwelling_SB, tsa, cap, agulhas_gradient, sst_AB, sst_SB, ## environmental drivers
         chla_SB, chla_AB, chlaship_AB,## primary production
         # pico_SB, pico_AB, nano_SB, nano_AB, micro_SB, micro_AB, ## phytoplankton size
         copepodabund_SB, accs_SB, mdlgzp_SB, smallzp_SB, copepod_AB, calanus_AB, smcopepod_AB, # zooplankton community     
         biomass_Anchovy, biomass_Sardine, log_rps_Anchovy, log_rps_Sardine,## fish
         anchovy_catches, sardine_catches) %>% ## removals
  as.data.frame()

## guidance from ??make_dsem_ram()
### X -> Y, 1, XtoY indicates that X in time T affects Y in time T+1)
### X -> Y, 0, XtoY indicates X affects Y simultaneously (lag=0) 

# Specify model
sem_fish <- "
  # Link, lag, param_name (NA = off), fixed value (optional, 1 if param is off)
  
  ## AB environment mediates primary production
  upwelling_AB -> chla_AB, 0, upwelling_to_ppAB
  sst_AB -> chla_AB, 0, sst_to_ppAB

  ## SB environment mediates primary production
  upwelling_SB -> chla_SB, 0, upwelling_to_ppSB
  sst_SB -> chla_SB, 0, sst_to_ppSB

  ## AB Trophic links between PP and zooplankton
  # chla_AB -> copepod_AB, 0, chla_to_copepodAB
  chla_AB -> calanus_AB, 0, chla_to_calanusAB
  chla_AB -> smcopepod_AB, 0, chla_to_smallcopepodAB
 
  ## SB Trophic links between PP and zooplankton
  chla_SB -> mdlgzp_SB, 0, chla_to_largezpSB
  # chla_SB -> copepodabund_SB, 0, chla_to_copeopodabundSB
  chla_SB -> smallzp_SB, 0, chla_to_smallzpSB
  # chla_SB -> accs_SB, 0, chla_to_accsSB

  ## SB Trophic links between zoop and small pelagics
  mdlgzp_SB -> log_rps_Anchovy, 0, zoop_to_survivalA
  smallzp_SB -> log_rps_Sardine, 0, zoop_to_survivalS
  
  # tsa -> log_rps_Anchovy, 0, tsa_to_survivalA
  # cap -> log_rps_Anchovy, 0, cap_to_survivalA
  # agulhas_gradient -> log_rps_Anchovy, 0, agulhasGrad_to_survivalA
  
  ## AB trophic links between zoop and small pelagics
  # copepod_AB -> biomass_Anchovy, 0, copepod_to_biomassA
  calanus_AB -> biomass_Anchovy, 0, calanus_to_biomassA
  chla_AB -> biomass_Sardine, 0, chlaAB_to_biomassS
  chla_SB -> biomass_Sardine, 0, chlaSB_to_biomassS
  smcopepod_AB -> biomass_Sardine, 0, smcopepodAB_to_biomassS

  ## Stock-recruit relationship
  biomass_Anchovy -> log_rps_Anchovy, 0, biomassA_to_rpsA
  biomass_Sardine -> log_rps_Sardine, 0, biomasss_to_rpsS
  catches_Anchovy -> biomass_Anchovy, 0, catchesA_to_biomassA
  catches_Anchovy -> biomass_Sardine, 0, bycatchesA_to_biomassS
  catches_Sardine -> biomass_Sardine, 2, catchesS_to_biomassS

  ## AR
  upwelling_SB -> upwelling_SB, 1, AR1, 0.001
  upwelling_AB -> upwelling_AB, 1, AR2, 0.001
  sst_SB -> sst_SB, 1, AR3, 0.001
  sst_AB -> sst_AB, 1, AR4, 0.001
   
  chla_AB -> chla_AB, 1, AR5, 0.001
  calanus_AB -> calanus_AB, 1, AR7, 0.001
  smcopepod_AB -> smcopepod_AB, 1, AR8, 0.001
  # copepod_AB -> copepod_AB, 1, AR9, 0.001

  chla_SB -> chla_SB, 1,  AR10, 0.001
  mdlgzp_SB -> mdlgzp_SB, 1, AR11, 0.001
  smallzp_SB -> smallzp_SB, 1, AR12, 0.001
  # copepodabund_SB -> copepodabund_SB, 1, AR13, 0.001
  # accs_SB -> accs_SB, 1, AR14, 0.001
  
  biomass_Anchovy -> biomass_Anchovy, 1, AR15, 0.001 
  biomass_Sardine -> biomass_Sardine, 1, AR16, 0.001 
  log_rps_Anchovy -> log_rps_Anchovy, 1, AR17, 0.001
  log_rps_Sardine -> log_rps_Sardine, 1, AR18, 0.001
  catches_Sardine -> catches_Sardine, 1, AR19, 0.001
  catches_Anchovy -> catches_Anchovy, 1, AR20, 0.001
  # cap -> cap, 1, AR21, 0.001
  # tsa -> tsa, 1, AR22, 0.001
  # agulhas_gradient -> agulhas_gradient, 1, AR23, 0.001

#### ---
"
sem_dat_fish <- sem_dat_full %>% 
  select(year, upwelling_AB, 
         sst_AB,
         chla_SB, chla_AB,
         # chlaship_AB,
         upwelling_SB, sst_SB,
         # cap, tsa, agulhas_gradient,
         # copepodabund_SB,
         # accs_SB,
         smcopepod_AB,
         calanus_AB,
         # copepod_AB,
         mdlgzp_SB, smallzp_SB,
         log_rps_Anchovy, log_rps_Sardine, biomass_Anchovy, biomass_Sardine,
         catches_Anchovy = anchovy_catches, catches_Sardine = sardine_catches
  ) %>% 
  filter(!if_all(-year, is.na)) %>% 
  # filter(year >= 1979) %>%
  as.data.frame()

rownames(sem_dat_fish) <- sem_dat_fish$year
sem_dat_fish <- sem_dat_fish[,-1]


# Fit dsem
fit_fish <- dsem( sem = sem_fish,
                  tsdata = ts(sem_dat_fish),
                  family =  rep('fixed', ncol(sem_dat_fish)),
                  control = dsem_control(use_REML = TRUE, quiet=TRUE))
ParHat_fish = fit_fish$obj$env$parList()

summary_fish <- summary(fit_fish) %>% 
  mutate(sig = cut(p_value, breaks = c(-Inf, 0.01, 0.05, 0.10, Inf), 
                   labels = c("***", "**", "*", "NS")))
AIC(fit_fish)

lags_fish <- data.frame(summary(fit_fish)) %>% 
  filter(!grepl("^AR.*|^V\\[.*", name)) %>% 
  pull(lag) %>% 
  unique()


for(i in lags_fish){
  p1_fish <- NULL
  p2_fish <- NULL
  
  p1_fish <- plot( (as_fitted_DAG(fit_fish, lag = i)), edge_width = 1, type="width",
                   text_size = 4, show.legend = FALSE, box_x = 12) +
    scale_x_continuous(expand = c(0.05, 0.05)) +
    labs(title = sprintf("lag %s effects", i)) +
    NULL
  
  p1_fish <- ggplot_build(p1_fish)
  p1_fish$data[[1]]$edge_width <- 1
  
  
  p2_fish <- plot( (as_fitted_DAG(fit_fish, what="p_value", lag = i)), #edge_width = 2, 
                   type = "width",
                   text_size = 4, show.legend = FALSE, colors=c('black', 'black'), 
                   box_x = 12) +
    scale_x_continuous(expand = c(0.05, 0.05)) +
    labs(title = sprintf("Two-sided p-value (lag %s)", i)) +
    NULL
  
  
  p2_fish <- ggplot_build(p2_fish)
  p2_fish$data[[1]]$edge_width <- 1
  
  print(wrap_ggplot_grob(ggplot_gtable(p1_fish))/wrap_ggplot_grob(ggplot_gtable(p2_fish)))
}



# Timeseries plot
raw_dat_fish <- data.frame(year = rownames(sem_dat_fish), 
                         sem_dat_fish) %>% 
  pivot_longer(!year, names_to = "var", values_to = "value")

pred_model_fish <- data.frame(year = rownames(sem_dat_fish), 
                         ParHat_fish$x_tj) %>% 
  pivot_longer(!year, names_to = "var", values_to = "predicted")

pred_sd_fish <- data.frame(year = rownames(sem_dat_fish),
                      as.list(fit_fish$sdrep,what="Std.")$x_tj) %>% 
  pivot_longer(!year, names_to = "var", values_to = "SD")

pred_all_fish <- raw_dat_fish %>% 
  left_join(pred_model_fish, by = join_by(year, var)) %>% 
  left_join(pred_sd_fish, by = join_by(year, var)) %>% 
  mutate(lower = predicted - ifelse(is.na(SD), 0, SD),
         upper = predicted + ifelse(is.na(SD), 0, SD),
         year = as.numeric(year)) 

ts_plot_fish <- ggplot(pred_all_fish, aes(x = year, y = predicted, ymin = lower, ymax = upper, group = var)) +
  geom_path() +
  geom_ribbon(alpha = 0.2, color = "blue", fill = "blue") +
  geom_point(aes(x = year, y = value)) +
  facet_wrap(~var) +
  scale_x_continuous(limits = c(1979, 2020), breaks = seq(1965, 2020, 5)) +
  theme_minimal() +
  labs(x = "", y = "",
       title = "Estimated values",
       subtitle = "measurements (black dots), predicted values (blue lines), and 95% predictive intervals (\u00B11.96 SE)") +
  NULL
ts_plot_fish
```

# Discussion ---

Upwelling may have both positive and negative effects on small fish recruitment, which makes predicting species and communities responses to upwelling difficult.

## Supplemental plots

### Data

```{r ag-plot, fig.cap="Agulhas cross-shelf gradient", include = TRUE}
ag_plot
```

```{r, pres-plot, fig.cap="Atmospheric pressure (hPa)"}
pres_plot
```

```{r, cap-plot, fig.cap="Central Agulhas Pressure"}
cap_plot
```

```{r, sst-plot, fig.cap="SST"}
sst_plot
```

```{r, tsa-plot, fig.cap="TSA plot"}
tsa_plot
```

```{r, upsummer-plot, fig.cap="Summer upwelling"}
up_summer
```

```{r, pp-plot, fig.cap="PP plot"}
pp_plot
```

```{r, zoop-plot, fig.cap="Zooplankton plot"}
zoop_ab_plot
zoop_sb_plot
```

```{r, rec-plot, fig.cap="Recruitment plot"}
rec1
# bio1
# logrps_plot
```

```{r, bio-plot, fig.cap="Biomass plot"}
# rec1
bio1
# logrps_plot
```

```{r, logrps-plot, fig.cap="Log(R/S) plot"}
# rec1
# bio1
logrps_plot
```

```{r, catch-plot, fig.cap="Catch plot"}
sp_plot
# sard1
# anch1
```

```{r, sard1-plot, fig.cap= "Sardine catches"}
sard1
```

```{r, anch1-plot, fig.cap= "Sardine catches"}
anch1
```

### Anchovy model ---

```{r sem_anchovy,eval=FALSE, echo = FALSE, message=FALSE, warning=FALSE}
sem_dat_anch <- sem_dat %>% 
  select(year, upwelling, pp_large, pp_small, macrozooplankton,
         mesozooplankton, microzooplankton, 
         anchovy_recruits, anchovy_biomass_total, anchovy_catches) %>% 
  as.data.frame()

rownames(sem_dat_anch) <- sem_dat_anch$year
sem_dat_anch <- sem_dat_anch[,-1]
# Z = ts(sem_dat_anch)

# family = rep('fixed', ncol(sem_dat_anch))

## guidance from ??make_dsem_ram()
### X -> Y, 1, XtoY indicates that X in time T affects Y in time T+1)
### X -> Y, 0, XtoY indicates X affects Y simultaneously (lag=0) 
# Specify model
sem_anch <- "
  # Link, lag, param_name (NA = off), fixed value (optional, 1 if param is off)
  
  upwelling -> pp_large, 0, upwelling_to_ppL
  upwelling -> pp_small, 0, upwelling_to_ppS
  pp_large -> macrozooplankton, 0, ppL_to_zoopMacro
  pp_small -> macrozooplankton, 0, ppS_to_zoopMacro
  pp_large -> mesozooplankton, 0, ppL_to_zoopMeso
  pp_small -> mesozooplankton, 0, ppS_to_zoopMeso
  pp_large -> microzooplankton, 0, ppL_to_zoopMicro
  pp_small -> microzooplankton, 0, ppS_to_zoopMicro
  macrozooplankton -> anchovy_recruits, 1, zoopMacro_to_recruitsA
  mesozooplankton -> anchovy_recruits, 1, zoopMeso_to_recruitsA
  microzooplankton -> anchovy_recruits, 1, zoopMicro_to_recruitsA
  anchovy_recruits -> anchovy_biomass_total, 1, recruitsA_to_biomssA
  anchovy_biomass_total -> anchovy_catches, 1, biomassA_to_catches
  
  upwelling -> upwelling, 1, AR1, 0.001
  pp_large -> pp_large, 1,  AR2, 0.001
  pp_small -> pp_small, 1, AR3, 0.001
  macrozooplankton -> macrozooplankton, 1, AR4, 0.001
  mesozooplankton -> mesozooplankton, 1, AR5, 0.001
  microzooplankton -> microzooplankton, 1, AR6, 0.001
  anchovy_recruits ->  anchovy_recruits, 1, AR7, 0.001
  anchovy_biomass_total -> anchovy_biomass_total, 1, AR8, 0.001
  anchovy_catches -> anchovy_catches, 1, AR9, 0.001
"

# Fit dsem
fit_anch = dsem(sem = sem_anch,
            tsdata = ts(sem_dat_anch),
            family = rep('fixed', ncol(sem_dat_anch)),
            control = dsem_control(use_REML = TRUE, quiet=TRUE))

ParHat_anch = fit_anch$obj$env$parList()

```

```{r dag_anchovy, eval=FALSE}

dag_anchovy <- phylopath::DAG(pp_large~upwelling,
                    pp_small~upwelling,
                    macrozooplankton~pp_large,
                    mesozooplankton~pp_large,
                    microzooplankton~pp_large,
                    macrozooplankton~pp_small,
                    mesozooplankton~pp_small,
                    microzooplankton~pp_small,
                    anchovy_recruits~macrozooplankton,
                    anchovy_recruits~mesozooplankton,
                    anchovy_recruits~microzooplankton,
                    anchovy_biomass~anchovy_recruits,
                    anchovy_catch~anchovy_biomass)
  
da_plot <- plot(dag_anchovy, edge.width = 1, type="width",
           text_size = 5, show.legend = FALSE, box_x = 30) +
     scale_x_continuous(expand = c(0.4, 0.1))+
  labs(title = "directed acyclic graph - anchovy") +
  NULL
da_plot$layers[[1]]$mapping$edge_width = 1
da_plot

```

```{r dsem_anch_ts, eval=FALSE, warning=FALSE, message=FALSE}

# Timeseries plot
raw_dat <- data.frame(year = rownames(sem_dat_anch), 
                         sem_dat_anch) %>% 
  pivot_longer(!year, names_to = "var", values_to = "value")

pred_model <- data.frame(year = rownames(sem_dat_anch), 
                         ParHat_anch$x_tj) %>% 
  pivot_longer(!year, names_to = "var", values_to = "predicted")

pred_sd <- data.frame(year = rownames(sem_dat_anch),
                      as.list(fit_anch$sdrep,what="Std.")$x_tj) %>% 
  pivot_longer(!year, names_to = "var", values_to = "SD")

pred_all <- raw_dat %>% 
  left_join(pred_model, by = join_by(year, var)) %>% 
  left_join(pred_sd, by = join_by(year, var)) %>% 
  mutate(lower = predicted - ifelse(is.na(SD), 0, SD),
         upper = predicted + ifelse(is.na(SD), 0, SD),
         year = as.numeric(year)) 

ts_plot_anch <- ggplot(pred_all, aes(x = year, y = predicted, ymin = lower, ymax = upper, group = var)) +
  geom_path() +
  geom_ribbon(alpha = 0.2, color = "blue", fill = "blue") +
  geom_point(aes(x = year, y = value)) +
  facet_wrap(~var) +
  scale_x_continuous(limits = c(1979, 2020), breaks = seq(1965, 2020, 5)) +
  theme_minimal() +
  labs(x = "", y = "",
       title = "Estimated values",
       subtitle = "measurements (black dots), predicted values (blue lines), and 95% predictive intervals (\u00B11.96 SE)") +
  NULL
ts_plot_anch
```

```{r dsem_anch_dag, eval=FALSE, fig.height = 12, fig.width = 15}

anch_lags <- unique(as.numeric(summary(fit_anch)$lag))
for(i in anch_lags){
  
  p1_anch <- NULL
  p2_anch <- NULL

  p1_anch <- plot( (as_fitted_DAG(fit_anch, lag = i)), edge_width = 1, type="width",
                      text_size = 4, show.legend = FALSE, box_x = 12) +
    scale_x_continuous(expand = c(0.05, 0.05)) +
    labs(title = sprintf("lag %s effects", i)) +
    NULL

  p1_anch <- ggplot_build(p1_anch)
  p1_anch$data[[1]]$edge_width <- 1
  
  
  p2_anch <- plot( (as_fitted_DAG(fit_anch, what="p_value", lag = i)), #edge_width = 2, 
                      type = "width",
                      text_size = 4, show.legend = FALSE, colors=c('black', 'black'), 
                      box_x = 12) +
    scale_x_continuous(expand = c(0.05, 0.05)) +
    labs(title = sprintf("Two-sided p-value (lag %s)", i)) +
    NULL
  
  p2_anch <- ggplot_build(p2_anch)
  p2_anch$data[[1]]$edge_width <- 1
  
  print(wrap_ggplot_grob(ggplot_gtable(p1_anch))/wrap_ggplot_grob(ggplot_gtable(p2_anch)))
}

# 
# p1_anch <- plot( (as_fitted_DAG(fit_anch)), edge.width = 1, type="width",
#            text_size = 5, show.legend = FALSE, box_x = 30) +
#      scale_x_continuous(expand = c(0.4, 0.1))+
#   labs(title = "simultaneous effects")
# p1_anch$layers[[1]]$mapping$edge_width = 1
# p2_anch <- plot( (as_fitted_DAG(fit_anch, what="p_value")), edge.width = .5, type = "width",
#            text_size = 5, show.legend=FALSE, colors=c('black', 'black'), box_x = 30) +
#      scale_x_continuous(expand = c(0.4, 0.1)) +
#   labs(title = "Two-sided p-value")
# p2_anch$layers[[1]]$mapping$edge_width = 0.5
# 
# 

# 
# p1_anch
# p2_anch

```

```{r coef_anch, eval=FALSE}

coef_dat_anch <- data.frame(name = colnames(sem_dat_anch), summary(fit_anch$sdrep)[1:9,]) %>%
  rename(coef = 2, "std_error" = 3) %>%
  mutate(upper = coef + std_error,
         lower = coef - std_error)

coef_plot_anch <- ggplot(coef_dat_anch, aes(x = name, y = coef, ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0) +
  geom_linerange() +
  geom_point() +
  coord_flip() +
  labs(x = "", y = "standardized regression coefficient") +
  theme_bw()

coef_plot_anch
```

### Sardine model---

```{r sem_sardine, eval=FALSE, echo = FALSE}
sem_dat_sardine <- sem_dat %>% 
  select(year, 
         upwelling, sbni, ## environmental drivers
         pp_large, pp_small, ## primary producers
         macrozooplankton, mesozooplankton, microzooplankton, ## zooplankton
         sardine_recruits, sardine_biomass_total, ## fish
         anchovy_catches, sardine_catches) %>% ## removals
  as.data.frame()

rownames(sem_dat_sardine) <- sem_dat_sardine$year
sem_dat_sardine <- sem_dat_sardine[,-1]

## guidance from ??make_dsem_ram()
### X -> Y, 1, XtoY indicates that X in time T affects Y in time T+1)
### X -> Y, 0, XtoY indicates X affects Y simultaneously (lag=0) 

# Specify model
sem_sard <- "
  # Link, lag, param_name (NA = off), fixed value (optional, 1 if param is off)
  
  upwelling -> pp_large, 0, upwelling_to_ppL
  upwelling -> pp_small, 0, upwelling_to_ppS
  pp_large -> macrozooplankton, 0, ppL_to_zoopMacro
  pp_small -> macrozooplankton, 0, ppS_to_zoopMacro
  pp_large -> mesozooplankton, 0, ppL_to_zoopMeso
  pp_small -> mesozooplankton, 0, ppS_to_zoopMeso
  pp_large -> microzooplankton, 0, ppL_to_zoopMicro
  pp_small -> microzooplankton, 0, ppS_to_zoopMicro
  sbni -> sardine_recruits, 0, sbni_to_recruitsS
  macrozooplankton -> sardine_recruits, 1, zoopMacro_to_recruitsS
  mesozooplankton -> sardine_recruits, 1, zoopMeso_to_recruitsS
  microzooplankton -> sardine_recruits, 1, zoopMicro_to_recruitsS
  sardine_recruits -> sardine_biomass_total, 1, recruitsA_to_biomssS
  anchovy_catches -> sardine_biomass_total, 1, catchesA_to_biomassS
  sardine_biomass_total -> sardine_catches, 2, biomassA_to_catchesS
  
  upwelling -> upwelling, 1, AR1, 0.001
  pp_large -> pp_large, 1,  AR2, 0.001
  pp_small -> pp_small, 1, AR3, 0.001
  macrozooplankton -> macrozooplankton, 1, AR4, 0.001
  mesozooplankton -> mesozooplankton, 1, AR5, 0.001
  microzooplankton -> microzooplankton, 1, AR6, 0.001
  sardine_recruits ->  sardine_recruits, 1, AR7, 0.001
  sardine_biomass_total -> sardine_biomass_total, 1, AR8, 0.001
  anchovy_catches -> anchovy_catches, 1, AR9, 0.001
  sbni -> sbni, 1, AR10, 0.001
  sardine_catches -> sardine_catches, 1, AR11, 0.001
"

# Fit dsem
fit_sardine = dsem( sem = sem_sard,
            tsdata = ts(sem_dat_sardine),
            family =  rep('fixed', ncol(sem_dat_sardine)),
            control = dsem_control(use_REML = TRUE, quiet=TRUE))

ParHat_sardine = fit_sardine$obj$env$parList()


```

```{r dag_sardine, eval=FALSE}
dag_sardine <- phylopath::DAG(pp_large~upwelling,
                              pp_small~upwelling,
                              macrozooplankton~pp_large,
                              mesozooplankton~pp_large,
                              microzooplankton~pp_large,
                              macrozooplankton~pp_small,
                              mesozooplankton~pp_small,
                              microzooplankton~pp_small,
                              sardine_recruits~macrozooplankton,
                              sardine_recruits~mesozooplankton,
                              sardine_recruits~microzooplankton,
                              sardine_recruits~sbni,
                              sardine_biomass~anchovy_catches,
                              sardine_biomass~sardine_recruits,
                              sardine_catch~sardine_biomass)

ds_plot <- plot(dag_sardine,edge_width = 1, type="width",
                text_size = 4, show.legend = FALSE, box_x = 12) +
  scale_x_continuous(expand = c(0.05, 0.05)) +  
  labs(title = "directed acyclic graph - sardine") +
  NULL

ds_plot <- ggplot_build(ds_plot)
ds_plot$data[[1]]$edge_width <- 1
plot(ggplot_gtable(ds_plot))

```

```{r dsem_sardine_ts, eval=FALSE, warning=FALSE, message=FALSE}

# Timeseries plot
raw_dat_sardine <- data.frame(year = rownames(sem_dat_sardine), 
                         sem_dat_sardine) %>% 
  pivot_longer(!year, names_to = "var", values_to = "value")

pred_model_sardine <- data.frame(year = rownames(sem_dat_sardine), 
                         ParHat_sardine$x_tj) %>% 
  pivot_longer(!year, names_to = "var", values_to = "predicted")

pred_sd_sardine <- data.frame(year = rownames(sem_dat_sardine),
                      as.list(fit_sardine$sdrep,what="Std.")$x_tj) %>% 
  pivot_longer(!year, names_to = "var", values_to = "SD")

pred_all_sardine <- raw_dat_sardine %>% 
  left_join(pred_model_sardine, by = join_by(year, var)) %>% 
  left_join(pred_sd_sardine, by = join_by(year, var)) %>% 
  mutate(lower = predicted - ifelse(is.na(SD), 0, SD),
         upper = predicted + ifelse(is.na(SD), 0, SD),
         year = as.numeric(year)) 

ts_plot_sardine <- ggplot(pred_all_sardine, aes(x = year, y = predicted, ymin = lower, ymax = upper, group = var)) +
  geom_path() +
  geom_ribbon(alpha = 0.2, color = "blue", fill = "blue") +
  geom_point(aes(x = year, y = value)) +
  facet_wrap(~var) +
  scale_x_continuous(limits = c(1979, 2020), breaks = seq(1965, 2020, 5)) +
  theme_minimal() +
  labs(x = "", y = "",
       title = "Estimated values",
       subtitle = "measurements (black dots), predicted values (blue lines), and 95% predictive intervals (\u00B11.96 SE)") +
  NULL
ts_plot_sardine
```

```{r dsem_sardine_dag, eval=FALSE, fig.height = 12, fig.width = 15}

sard_lags <- unique(as.numeric(summary(fit_sardine)$lag))
for(i in 0:sard_lags){
  
  p1_sardine <- NULL
  p2_sardine <- NULL

  p1_sardine <- plot( (as_fitted_DAG(fit_sardine, lag = i)), edge_width = 1, type="width",
                      text_size = 4, show.legend = FALSE, box_x = 12) +
    scale_x_continuous(expand = c(0.05, 0.05)) +
    labs(title = sprintf("lag %s effects", i)) +
    NULL

  p1_sardine <- ggplot_build(p1_sardine)
  p1_sardine$data[[1]]$edge_width <- 1
  
  
  p2_sardine <- plot( (as_fitted_DAG(fit_sardine, what="p_value", lag = i)), #edge_width = 2, 
                      type = "width",
                      text_size = 4, show.legend = FALSE, colors=c('black', 'black'), 
                      box_x = 12) +
    scale_x_continuous(expand = c(0.05, 0.05)) +
    labs(title = sprintf("Two-sided p-value (lag %s)", i)) +
    NULL
  
  
  p2_sardine <- ggplot_build(p2_sardine)
  p2_sardine$data[[1]]$edge_width <- 1
  
  print(wrap_ggplot_grob(ggplot_gtable(p1_sardine))/wrap_ggplot_grob(ggplot_gtable(p2_sardine)))
}

```

```{r sard_coef, eval=FALSE}

coef_dat_sardine <- data.frame(name = colnames(sem_dat_sardine), summary(fit_sardine$sdrep)[1:11,]) %>% 
  rename(coef = 2, "std_error" = 3) %>% 
  mutate(upper = coef + std_error,
         lower = coef - std_error)

coef_plot_sardine <- ggplot(coef_dat_sardine, aes(x = name, y = coef, ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0) +
  geom_linerange() +
  geom_point() + 
  coord_flip() +
  labs(x = "", y = "standardized regression coefficient") +
  theme_bw()

# p1_sardine
# p2_sardine
coef_plot_sardine


```

```{r, eval = FALSE}
sem_full <- "
  # Link, lag, param_name (NA = off), fixed value (optional, 1 if param is off)
  
  ## Environment mediates primary production
  upwelling_SB -> chla_SB, 0, upwelling_to_ppSB

  ## Trophic links between PP and zooplankton
  # chla_SB -> copepodabund_SB, 0, chla_to_copepod
  chla_SB -> mdlgzp_SB, 0, chla_to_largeZP
  chla_SB -> smallzp_SB, 0, chla_to_smallZP

  ## Larval conditions/survival (Southern Benguela)
  # upwelling_SB -> log_rps_Sardine, 0, upwelling_to_rpsS
  # upwelling_SB -> log_rps_Anchovy, 0, upwelling_to_rpsA
  
  ## Spawner conditions/transport (Agulhas)
  # cap -> log_rps_Sardine, 0, upwelling_to_rpsS
  # upwelling_SB -> log_rps_Anchovy, 0, upwelling_to_rpsA
  
  
  ## Sardine 
  # macrozooplankton -> sardine_recruits, 1, zoopMacro_to_recruitsS
  # mesozooplankton -> sardine_recruits, 1, zoopMeso_to_recruitsS
  # microzooplankton -> sardine_recruits, 1, zoopMicro_to_recruitsS
  
  # tsa -> biomass_Sardine, 0, tsa_to_biomassS
  # cap -> biomass_Sardine, 0, cap_to_biomassS
  
  # sardine_recruits -> sardine_biomass_east, 1, recruitsA_to_biomassES
  # anchovy_catches -> sardine_biomass_east, 1, catchesA_to_biomassES
  # sardine_catches -> sardine_biomass_east, 3, catchesS_to_biomassES
  # sardine_recruits -> sardine_biomass_west, 1, recruitsA_to_biomassWS
  # anchovy_catches -> sardine_biomass_west, 1, catchesA_to_biomassWS
  # sardine_catches -> sardine_biomass_west, 3, catchesS_to_biomassWS
  
  ## Anchovy
  # macrozooplankton -> anchovy_recruits, 1, zoopMacro_to_recruitsA
  # mesozooplankton -> anchovy_recruits, 1, zoopMeso_to_recruitsA
  # microzooplankton -> anchovy_recruits, 1, zoopMicro_to_recruitsA
  
  # tsa -> biomass_Anchovy, 0, tsa_to_biomassA
  # tsa -> anchovy_biomass_east, 1, tsa_to_biomassEA
  # cap -> biomass_Anchovy, 0, cap_to_biomassA
  # cap -> sardine_biomass_east, 1, cap_to_biomassEA
  # agulhas_gradient -> anchovy_biomass_east, 1, agulhas_to_biomassEA
  
  # anchovy_recruits -> anchovy_biomass_east, 1, recruitsA_to_biomassEA
  # anchovy_catches -> anchovy_biomass_east, 1, catchesA_to_biomassEA  
  # anchovy_recruits -> anchovy_biomass_west, 1, recruitsA_to_biomassWA
  # anchovy_catches -> anchovy_biomass_west, 1, catchesA_to_biomassWA  
  
  ## AR
  upwelling -> upwelling, 1, AR1, 0.001
  pp_large -> pp_large, 1,  AR2, 0.001
  pp_small -> pp_small, 1, AR3, 0.001
  macrozooplankton -> macrozooplankton, 1, AR4, 0.001
  mesozooplankton -> mesozooplankton, 1, AR5, 0.001
  microzooplankton -> microzooplankton, 1, AR6, 0.001
  anchovy_recruits ->  anchovy_recruits, 1, AR7, 0.001
  sardine_biomass_west -> sardine_biomass_west, 1, AR8, 0.001
  anchovy_biomass_west -> anchovy_biomass_west, 1, AR9, 0.001
  sardine_biomass_east -> sardine_biomass_east, 1, AR10, 0.001
  anchovy_biomass_east -> anchovy_biomass_east, 1, AR11, 0.001
  anchovy_catches -> anchovy_catches, 1, AR12, 0.001
  # cap -> cap, 1, AR13, 0.001
  # tsa -> tsa, 1, AR14, 0.001
  # agulhas_gradient -> agulhas_gradient, 1, AR15, 0.001
"

```
